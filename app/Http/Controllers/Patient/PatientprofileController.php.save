<?php namespace App\Http\Controllers\Patient;

use Carbon\Carbon;
use App\Http\Requests;
use App\Http\Controllers\Controller;

use App\Patientprofile;
use App\BSM;
use Illuminate\Http\Request;

class PatientprofileController extends Controller {


	public function __construct()
	{
		// \Debugbar::disable();
	}

	/**
	 * Display a listing of the resource.
	 *
	 * @return Response
	 */
	public function index(Request $request)
	{
		$query = $request->search;
		$category = $request->category;
	        if (count($query) >= 1)
	        {
	           switch ($category) {
	             case 1:
	               $field = 'pp_name';
	               break;
	             case 2:
	               $field = 'pp_patientid';
	               break;
	             case 3:
	               $field = 'pp_personid';
	               break;
	           }
	           $result = Patientprofile::where($field, 'like', '%' . $query . '%')->orderBy('created_at', 'desc');
	        }
	        else
	           $result = Patientprofile::orderBy('created_at', 'desc');

		$patientprofiles = $result->paginate(10);

		return view('patient.index', compact('patientprofiles'));
	}

	/**
	 * Show the form for creating a new resource.
	 *
	 * @return Response
	 */
	public function create()
	{
		$carbon = Carbon::today();
		// $format = $carbon->format('Y-m-d H:i:s');
		$year = $carbon->year;

		$bsms = BSM::orderBy('bm_order')->get();
		return view('patient.create', compact('year', 'bsms'));
	}

	/**
	 * Store a newly created resource in storage.
	 *
	 * @param Request $request
	 * @return Response
	 */
	public function store(Request $request)
	{
                $this->validate($request, Patientprofile::rules());

		$patientprofile = new Patientprofile();
                $patientprofile->pp_patientid = $request->input("pp_patientid");
                $patientprofile->pp_personid = $request->input("pp_personid");
                $patientprofile->pp_name = $request->input("pp_name");
                $patientprofile->pp_birthday = $request->input("pp_birthday");
                $patientprofile->pp_sex = $request->input("pp_sex");
                $patientprofile->pp_height = $request->input("pp_height");
                $patientprofile->pp_weight = $request->input("pp_weight");
                $patientprofile->pp_tel1 = $request->input("pp_tel1");
                $patientprofile->pp_tel2 = $request->input("pp_tel2");
                $patientprofile->pp_mobile1 = $request->input("pp_mobile1");
                $patientprofile->pp_mobile2 = $request->input("pp_mobile2");
                $patientprofile->pp_address = $request->input("pp_address");
                $patientprofile->pp_email = $request->input("pp_email");
		$patientprofile->save();

		$bsm = new BSM();
		

		return redirect()->route('patient.index')->with('message', '项目成功创建。');
	}

	/**
	 * Display the specified resource.
	 *
	 * @param  int  $id
	 * @return Response
	 */
	public function show($id)
	{
		$patientprofile = Patientprofile::findOrFail($id);

		return view('patient.show', compact('patientprofile'));
	}

	/**
	 * Show the form for editing the specified resource.
	 *
	 * @param  int  $id
	 * @return Response
	 */
	public function edit($id)
	{
		$patientprofile = Patientprofile::findOrFail($id);

		return view('patient.edit', compact('patientprofile'));
	}

	/**
	 * Update the specified resource in storage.
	 *
	 * @param  int  $id
	 * @param Request $request
	 * @return Response
	 */
	public function update(Request $request, $id)
	{
		$this->validate($request, Patientprofile::rules());

		$patientprofile = Patientprofile::findOrFail($id);

                $patientprofile->pp_patientid = $request->input("pp_patientid");
                $patientprofile->pp_personid = $request->input("pp_personid");
//                $patientprofile->account = $request->input("account");
                $patientprofile->pp_name = $request->input("pp_name");
                $patientprofile->pp_birthday = $request->input("pp_birthday");
                $patientprofile->pp_sex = $request->input("pp_sex");
                $patientprofile->pp_height = $request->input("pp_height");
                $patientprofile->pp_weight = $request->input("pp_weight");
                $patientprofile->pp_tel1 = $request->input("pp_tel1");
                $patientprofile->pp_tel2 = $request->input("pp_tel2");
                $patientprofile->pp_mobile1 = $request->input("pp_mobile1");
                $patientprofile->pp_mobile2 = $request->input("pp_mobile2");
                $patientprofile->pp_address = $request->input("pp_address");
                $patientprofile->pp_email = $request->input("pp_email");

		$patientprofile->save();

		return redirect()->route('patient.index')->with('message', '项目成功更新。');
	}

	/**
	 * Remove the specified resource from storage.
	 *
	 * @param  int  $id
	 * @return Response
	 */
	public function destroy($id)
	{
		$patientprofile = Patientprofile::findOrFail($id);
		$patientprofile->delete();

		return redirect()->route('patient.index')->with('message', '项目成功删除。');
	}

}
