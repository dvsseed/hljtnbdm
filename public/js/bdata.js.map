{"version":3,"sources":["bdata.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"bdata.js","sourcesContent":["/**\r\n * Created by purplebleed on 2015/9/22.\r\n */\r\n\r\nvar mapping = {\r\n    'early_morning': '凌晨',\r\n    'morning': '晨起',\r\n    'breakfast_before': '早餐飯前',\r\n    'breakfast_after': '早餐飯後',\r\n    'lunch_before': '中餐飯前',\r\n    'lunch_after': '中餐飯後',\r\n    'dinner_before': '晚餐飯前',\r\n    'dinner_after': '晚餐飯後',\r\n    'sleep_before': '睡前'\r\n};\r\nvar mapping_time = {\r\n    'early_morning': '00:01',\r\n    'morning': '06:01',\r\n    'breakfast_before': '07:01',\r\n    'breakfast_after': '09:01',\r\n    'lunch_before': '11:01',\r\n    'lunch_after': '13:01',\r\n    'dinner_before': '17:01',\r\n    'dinner_after': '19:01',\r\n    'sleep_before': '20:01'\r\n};\r\nvar patt = /\\d{4}-\\d{2}-\\d{2}/;\r\n$( document ).ready(function() {\r\n\r\n    $(\".menuLink\").on('click', function (e) {\r\n        $(this).parent().parent().find('.active').removeClass('active');\r\n        $('.nav').find('.active').removeClass('active');\r\n        $(this).parent().addClass('active');\r\n        $('.content').hide();\r\n\r\n        if(!$(this).hasClass(\"real\")){\r\n            e.preventDefault();\r\n        }\r\n\r\n        var link = $(this).attr('href');\r\n        if( link == '#batchInsert'){\r\n            link = '#data';\r\n        }\r\n\r\n        $(link).show({\r\n            duration: 1,\r\n            always: checkContent\r\n        });\r\n        if($(this).attr('href') == \"#message\"){\r\n            setUpMessage();\r\n        }else if($(this).attr('href') == \"#statics\"){\r\n            getStaticsData();\r\n        }\r\n    });\r\n\r\n    $('#timepicker').timepicker({\r\n        defaultTime: '00:01',\r\n        minutes: {\r\n            starts: 0,\r\n            ends: 59,\r\n            interval: 1,\r\n            manual: []\r\n        }\r\n    });\r\n\r\n    $('#food_timepicker').timepicker({\r\n        defaultTime: '00:01',\r\n        minutes: {\r\n            starts: 0,\r\n            ends: 59,\r\n            interval: 1,\r\n            manual: []\r\n        }\r\n    });\r\n    $(\"#dialog\").dialog({\r\n        autoOpen: false\r\n    });\r\n\r\n    var mode = getUrlParameter(\"mode\");\r\n    if(mode){\r\n        if($(\"[href =\" +  \"#\" + mode +\"]\").length > 0){\r\n            $(\"[href =\" +  \"#\" + mode +\"]\").click();\r\n        }\r\n        else{\r\n            $('[href ' + '= #data]').click();\r\n        }\r\n    }\r\n    else{\r\n        $('[href =' + ' #data]').click();\r\n    }\r\n});\r\n\r\nfunction openDialog(text, event){\r\n\r\n\r\n    $(\"#dialog\").html(text);\r\n    $(\"#dialog\").dialog(\"option\", \"position\", {\r\n        my: \"left+20 top+10\",\r\n        of: event\r\n    });\r\n    $(\"#dialog\").dialog(\"open\");\r\n    $(this).blur();\r\n    event.preventDefault();\r\n}\r\n\r\nfunction getUrlParameter(sParam) {\r\n    var sPageURL = decodeURIComponent(window.location.search.substring(1)),\r\n        sURLVariables = sPageURL.split('&'),\r\n        sParameterName,\r\n        i;\r\n\r\n    for (i = 0; i < sURLVariables.length; i++) {\r\n        sParameterName = sURLVariables[i].split('=');\r\n\r\n        if (sParameterName[0] === sParam) {\r\n            return sParameterName[1] === undefined ? true : sParameterName[1];\r\n        }\r\n    }\r\n};\r\n\r\nfunction updateNote(calendar_date, ele){\r\n    var text = \"\";\r\n    if(ele != null)\r\n        text = $(ele).attr('title');\r\n    $(\"#day_note\").val(text);\r\n    $(\"#calendar_date_note\").html(calendar_date);\r\n\r\n    $(\"#note_filter\").show();\r\n    $(\"#insert_note_data\").show();\r\n\r\n    $(\"#save_note\").unbind('click').click(function(event){\r\n        var insert_data = {};\r\n        insert_data['day_note'] = $(\"#day_note\").val();\r\n        insert_data['calendar_date'] = calendar_date;\r\n        insert_data['_token'] = $('input[name=_token]').val();\r\n        $.ajax({\r\n            type: 'POST',\r\n            url: '/bdata/upsert_note',\r\n            data: insert_data,\r\n            success: function(result){\r\n                if(result == \"success\"){\r\n                    location.reload();\r\n                }else{\r\n                    alert(\"儲存失敗\");\r\n                }\r\n            },\r\n            error: function(){\r\n                alert(\"儲存失敗\");\r\n            }\r\n        });\r\n        event.preventDefault();\r\n    });\r\n\r\n    $(\"#cancel_note\").unbind('click').click(function(event){\r\n        $(\"#note_filter\").hide();\r\n        $(\"#insert_note_data\").hide();\r\n        event.preventDefault();\r\n    });\r\n\r\n}\r\n\r\nfunction checkContent(){\r\n    if($(this).attr('id') == 'data'){\r\n        var active = $(\"#top\").find('.active').children('a').attr('href');\r\n\r\n        var trs = $(\"#sugartable > tbody\").children(\"tr\");\r\n        for(var i = 2; i < trs.length; i++){\r\n            var tr = $(trs[i]);\r\n            tr.children('td').each (function() {\r\n                if(active == '#data'){\r\n                    $(this).children('#normal').show();\r\n                    $(this).children('#sugar_batch').hide();\r\n                    $(this).children('#sugar_batch_empty').hide();\r\n                }else if(active == '#batchInsert'){\r\n                    $(this).children('#normal').hide();\r\n                    $(this).children('#sugar_batch').show();\r\n                }\r\n            });\r\n\r\n            if(active == '#batchInsert'){\r\n                tr.find('#sugar_batch_empty').show();\r\n                tr.find('#sugar_batch_empty').click(function(){\r\n                    var tr = $(this).parents('tr');\r\n                    tr.children('td').each (function() {\r\n                        $(this).children('#sugar_batch').val(\"\");\r\n                    });\r\n                });\r\n            }\r\n        }\r\n        if(active == '#data'){\r\n            $('.statics_data').show();\r\n            $('.batch_save_tr').hide();\r\n        }else if(active == '#batchInsert'){\r\n            $('.statics_data').hide();\r\n            $('.batch_save_tr').show();\r\n        }\r\n\r\n        if(active == '#batchInsert'){\r\n\r\n            $('#batch_save_btn').unbind('click').click(function(event){\r\n                $(this).prop('disabled', true);\r\n                var flag = true;\r\n                var batch_data = [];\r\n                var trs = $(\"#sugartable > tbody\").children(\"tr\");\r\n                for(var i = 2; i < trs.length; i++){\r\n                    var single_record = {};\r\n                    var tr = $(trs[i]);\r\n                    tr.children('td').each (function() {\r\n                        if($(this).children('#sugar_batch')){\r\n                            var sugar_value = $(this).children('#sugar_batch').val();\r\n                            if(isNaN(sugar_value)){\r\n                                flag = false;\r\n                                $(this).children('#sugar_batch').addClass('error');\r\n                            }else if(sugar_value != ''){\r\n\r\n                                single_record[$(this).children('#sugar_batch').attr('data')] = sugar_value;\r\n                            }\r\n                        }\r\n                    });\r\n\r\n                    if(patt.test(tr.children('td:first').html())){\r\n                        single_record['calendar_date'] = tr.children('td:first').html();\r\n                    }\r\n\r\n                    if(!$.isEmptyObject(single_record)){\r\n                        batch_data.push(single_record);\r\n                    }\r\n                }\r\n                console.log(batch_data);\r\n                event.preventDefault();\r\n                $(this).blur();\r\n                var inputdata = {};\r\n                inputdata['sugar_data'] = batch_data;\r\n                inputdata['_token'] = $('#batch_form > input[ name=_token]').val();\r\n                $.ajax({\r\n                    type: 'POST',\r\n                    url: '/bdata/batch_update',\r\n                    data: inputdata,\r\n                    success: function(result){\r\n                        if(result == 'success'){\r\n                            location.reload();\r\n                        }\r\n                    }\r\n                });\r\n            });\r\n\r\n            var href = $(\"#before_two_week\").attr('href');\r\n            if(href)\r\n                $(\"#before_two_week\").attr('href', href + \"?mode=batchInsert\");\r\n            href = $(\"#after_two_week\").attr('href');\r\n            if(href)\r\n                $(\"#after_two_week\").attr('href', href + \"?mode=batchInsert\");\r\n        }\r\n        else if(active == '#data'){\r\n            var href = $(\"#before_two_week\").attr('href');\r\n            href = href.split('?')[0]\r\n            if(href)\r\n                $(\"#before_two_week\").attr('href', href);\r\n            href = $(\"#after_two_week\").attr('href');\r\n            if(href)\r\n                $(\"#after_two_week\").attr('href', href);\r\n        }\r\n    }\r\n}\r\n\r\nfunction setUpBatch(){\r\n    $(\"#batch\").click(function(event){\r\n        event.preventDefault();\r\n        $(this).parent().parent().find('.active').removeClass('active');\r\n        $('.nav').find('.active').removeClass('active');\r\n        $(this).parent().addClass('active');\r\n        $('#data').show();\r\n\r\n        var trs = $(\"#sugartable > tbody\").children(\"tr\");\r\n        for(var i = 2; i < trs.length; i++){\r\n            var tr = $(trs[i]);\r\n            tr.children('td').each (function() {\r\n                $(this).children('#normal').hide();\r\n                $(this).children('#sugar_batch').show();\r\n            });\r\n            tr.find('#sugar_batch_empty').show();\r\n            tr.find('#sugar_batch_empty').click(function(){\r\n                var tr = $(this).parents('tr');\r\n                tr.children('td').each (function() {\r\n                    $(this).children('#sugar_batch').val(\"\");\r\n                });\r\n            });\r\n        }\r\n\r\n        $('.statics_data').hide();\r\n        $('.batch_save_tr').show();\r\n    });\r\n}\r\n\r\nfunction setUpMessage(){\r\n    //setting for message\r\n    $(\"#messages\").css('height', $( window ).height() - $(\"#top\").offset().top - $(\"#top\").height() - 150 );\r\n    $(\"#reply\").click(function(event){\r\n        var inputdata = {};\r\n        inputdata['message_body'] = $(\"#messagearea\").val();\r\n        inputdata['_token'] = $('#message_form > input[ name=_token]').val();\r\n        event.preventDefault();\r\n\r\n        if(inputdata['message_body'] == '' ){\r\n            $(\"#messagearea\").addClass('error');\r\n        }else{\r\n            $.ajax({\r\n                type: 'POST',\r\n                url: '/bdata/post_message',\r\n                data: inputdata,\r\n                success: function(result){\r\n                    if(result == 'success'){\r\n                        getMessageData();\r\n                        $(\"#reply\").blur();\r\n                        $(\"#messagearea\").val('');\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    });\r\n\r\n    $('#messages').scroll(function() {\r\n        if($('#messages').scrollTop() + $('#messages').height() == $(\"#message_table\").height()) {\r\n            $.ajax({\r\n                type: 'GET',\r\n                url: '/bdata/message?start=' + $('#message_count').val(),\r\n                success: function(result){\r\n                    var trs = $(result).find(\"tr\");\r\n                    for(var i = 0; i < trs.length; i++){\r\n                        var tr = $(trs[i]);\r\n                        tr.insertAfter('#message_table tr:last');\r\n                    }\r\n                    $('#message_count').val(parseInt($('#message_count').val()) + trs.length);\r\n                }\r\n            });\r\n        }\r\n    });\r\n\r\n    getMessageData();\r\n}\r\n\r\nfunction getStaticsData(){\r\n    $.ajax({\r\n        type: 'GET',\r\n        url: '/bdata/food/statics',\r\n        success: function(result){\r\n            $(\"#statics\").html(result);\r\n        }\r\n    });\r\n}\r\n\r\nfunction getMessageData(){\r\n    $.ajax({\r\n        type: 'GET',\r\n        url: '/bdata/message',\r\n        success: function(result){\r\n            $(\"#messages\").html(result);\r\n        }\r\n    });\r\n}\r\n\r\nfunction clear(amount,unit){\r\n    amount.val(\"\");\r\n    unit.val(\"gram\");\r\n    calc_sugar();\r\n}\r\n\r\nfunction foodHandler(event){\r\n    var food_type =event.data.type;\r\n    var default_value =event.data.value;\r\n    var food_category =event.data.category;\r\n    if(food_category.val() != 0){\r\n\r\n        $.ajax({\r\n            type: 'GET',\r\n            url: '/bdata/foods/'+food_category.val(),\r\n            success: function(result){\r\n                var html =\"\";\r\n\r\n                if(result.length > 0){\r\n                    for(i = 0; i < result.length; i++){\r\n                        if(default_value == result[i].food_pk)\r\n                            html += \"<option selected value='\" + result[i].food_pk + \"' gram='\" + result[i].gram_sugar_value + \"' set='\" + result[i].set_sugar_value + \"'>\"+result[i].food_name + \"</option>\";\r\n                        else\r\n                            html += \"<option value='\" + result[i].food_pk + \"' gram='\" + result[i].gram_sugar_value + \"' set='\" + result[i].set_sugar_value + \"'>\" + result[i].food_name + \" </option>\";\r\n                    }\r\n                }\r\n                else{\r\n                    html = \"<option value=\\\"0\\\">無</option>\";\r\n                }\r\n\r\n                food_type.html(html);\r\n\r\n                set_sugar_option_value();\r\n                calc_sugar();\r\n            }\r\n        });\r\n    }\r\n    else{\r\n        food_type.html(\"<option value=\\\"0\\\">無</option>\");\r\n    }\r\n\r\n\r\n    clear(food_type.parent().parent(\"tr\").find(\"#amount\"), food_type.parent().parent(\"tr\").find(\"#food_unit\"));\r\n\r\n    food_type.change(set_sugar_option_value);\r\n}\r\n\r\nfunction set_sugar_option_value(){\r\n    var gram_sugar_value = $(\"#food_type_option option:selected\").attr('gram');\r\n    var set_sugar_value = $(\"#food_type_option option:selected\").attr('set');\r\n\r\n    var html = \"<option value=\\\"gram\\\">公克 </option>\";\r\n    if(set_sugar_value){\r\n        html += \"<option value=\\\"set\\\">份 </option>\";\r\n    }\r\n\r\n    $(\"#food_unit\").html(html);\r\n}\r\n\r\nfunction calc_sugar(){\r\n    var trs = $(\"#sample > tbody\").children(\"tr\");\r\n\r\n    var total_sugar = 0.0;\r\n    for(var i = 1; i < trs.length; i++){\r\n        var tr = $(trs[i]);\r\n        var amount = tr.find('td').eq(3).attr(\"sugar\");\r\n        total_sugar += parseFloat(amount);\r\n    }\r\n\r\n    if(!isNaN(total_sugar))\r\n        $(\"#sugar_amount\").val(total_sugar);\r\n    else\r\n        $(\"#sugar_amount\").val(\"0.0\");\r\n}\r\n\r\nfunction setFoodList(food_category, food_type, default_value){\r\n    food_category.change({category: food_category,type:food_type,value:default_value},foodHandler);\r\n    food_type.change({type:food_type}, function(event){\r\n        var food_type = event.data.type;\r\n        clear(food_type.parent().parent(\"tr\").find(\"#amount\"), food_type.parent().parent(\"tr\").find(\"#food_unit\"));\r\n    });\r\n}\r\n\r\nfunction setAddFood(food_add_button){\r\n    food_add_button.click({button:food_add_button },function(event){\r\n\r\n        event.preventDefault();\r\n\r\n        var add_button = event.data.button;\r\n        var tr = add_button.parents(\"#sample tr\");\r\n\r\n        var food_category_pk =  tr.find(\"#food_category\").val();\r\n        var food_category_name =  tr.find(\"#food_category option:selected\").text();\r\n        var food_pk =  tr.find(\"#food_type_option\").val();\r\n        var food_name =  tr.find(\"#food_type_option option:selected\").text().split(\" \")[0];\r\n        var amount = tr.find(\"#amount\").val();\r\n        var unit = tr.find(\"#food_unit\").val();\r\n        var gram_sugar_value = tr.find(\"#food_type_option option:selected\").attr(\"gram\");\r\n        var set_sugar_value = tr.find(\"#food_type_option option:selected\").attr(\"set\");\r\n\r\n        var flag = true;\r\n\r\n        if(food_category_pk <= 0){\r\n            tr.find(\"#food_category\").addClass(\"error\");\r\n            flag = false;\r\n        }\r\n        if(food_pk <= 0){\r\n            tr.find(\"#food_type_option\").addClass(\"error\");\r\n            flag = false;\r\n        }\r\n        if(isNaN(amount) || amount <= 0){\r\n            tr.find(\"#amount\").addClass(\"error\");\r\n            flag = false;\r\n        }\r\n\r\n        if(flag){\r\n            var new_row = tr.clone();\r\n            new_row.insertAfter('#sample tr:last');\r\n\r\n            new_row.find(\"#delete_food\").show();\r\n            new_row.find(\"#add_food\").hide();\r\n            new_row.find('td').eq(1).attr(\"pk\",food_category_pk).html(food_category_name);\r\n            new_row.find('td').eq(2).attr(\"pk\",food_pk).html(food_name);\r\n            if (unit == \"gram\") {\r\n                var sugar = gram_sugar_value * amount;\r\n                new_row.find('td').eq(3).attr(\"sugar\", sugar).attr(\"unit\",\"gram\").attr(\"amount\",amount).html(amount + \" 克\");\r\n\r\n            }else if (unit == \"set\") {\r\n                var sugar = set_sugar_value * amount;\r\n                new_row.find('td').eq(3).attr(\"sugar\", sugar).attr(\"unit\",\"set\").attr(\"amount\",amount).html(amount + \" 份\");\r\n            }\r\n\r\n            setfoodRemove(new_row.find(\"#delete_food\"));\r\n\r\n            calc_sugar();\r\n            init_food_input();\r\n        }\r\n\r\n    });\r\n}\r\n\r\nfunction init_food_input(){\r\n    var tr = $(\"#sample tr:first\");\r\n    tr.find(\"#food_category\").removeClass(\"error\");\r\n    tr.find(\"#food_type_option\").removeClass(\"error\");\r\n    tr.find(\"#amount\").removeClass(\"error\");\r\n    tr.find(\"#add_food\").blur();\r\n\r\n    tr.find(\"#food_category\").val(\"0\");\r\n    tr.find(\"#food_type_option\").html(\"<option value=\\\"0\\\">無</option>\");\r\n    tr.find(\"#amount\").val(\"\");\r\n    tr.find(\"#food_unit\").val(\"gram\");\r\n\r\n}\r\n\r\nfunction setfoodRemove(delete_food){\r\n    delete_food.unbind(\"click\").click({button:delete_food },function(event){\r\n        event.preventDefault();\r\n\r\n        var delete_food = event.data.button;\r\n        delete_food.parents(\"#sample tr\").remove();\r\n\r\n        calc_sugar();\r\n    });\r\n}\r\n\r\nfunction updateBloodSugar(calendar_date, type, sugar_value) {\r\n\r\n    sugar_value = typeof sugar_value !== 'undefined' ? sugar_value : null;\r\n\r\n    $(\"#calendar_date\").html(calendar_date);\r\n    $(\"#range\").html(mapping[type]);\r\n    $(\"#range\").attr(\"value\",type);\r\n    $('#timepicker').timepicker('setTime', mapping_time[type]);\r\n\r\n    if (sugar_value != null) {\r\n        $.ajax({\r\n            method: \"GET\",\r\n            url: \"/bdata/detail/\" + calendar_date + \"/\" + type\r\n        }).done(function (result) {\r\n\r\n            $(\"#filter\").show();\r\n            $(\"#insert_data\").show();\r\n            $(\"#blood_sugar\").val(sugar_value);\r\n            if (result) {\r\n                if (result[\"measure_time\"])\r\n                    $('#timepicker').timepicker('setTime', result[\"measure_time\"].split(\" \")[1]);\r\n                else\r\n                    $('#timepicker').timepicker('setTime', mapping_time[type]);\r\n\r\n                if (result['exercise_type'] != null) {\r\n                    $('#sport').val(result['exercise_type']);\r\n                    $('#duration').val(result['exercise_duration']);\r\n                }\r\n                if (result['low_blood_sugar']) {\r\n                    $('#low').val(result['low_blood_sugar']);\r\n                }\r\n                if (result['insulin_type_1']) {\r\n                    $('#insulin_type_1').val(result['insulin_type_1']);\r\n                    $('#insulin_value_1').val(result['insulin_value_1']);\r\n                }\r\n                if (result['insulin_type_2']) {\r\n                    $('#insulin_type_2').val(result['insulin_type_2']);\r\n                    $('#insulin_value_2').val(result['insulin_value_2']);\r\n                }\r\n                if (result['insulin_type_3']) {\r\n                    $('#insulin_type_3').val(result['insulin_type_3']);\r\n                    $('#insulin_value_3').val(result['insulin_value_3']);\r\n                }\r\n                if (result['sugar']) {\r\n                    $('#sugar').val(result['sugar']);\r\n                }\r\n                if (result['note']) {\r\n                    $('#note').val(result['note']);\r\n                }\r\n            }\r\n\r\n        });\r\n    }\r\n    else{\r\n        $(\"#filter\").show();\r\n        $(\"#insert_data\").show();\r\n    }\r\n\r\n    $(\"#save\").unbind('click').click(function(){\r\n\r\n        var flag = true;\r\n\r\n        $(\"#blood_sugar_err\").html(\"\");\r\n        $(\"#insulin_1_err\").html(\"\");\r\n        $(\"#insulin_2_err\").html(\"\");\r\n        $(\"#insulin_3_err\").html(\"\");\r\n        $(\"#sugar_err\").html(\"\");\r\n\r\n        if($('#blood_sugar').val()  == \"\"){\r\n            $(\"#blood_sugar_err\").html(\"不能是空白\");\r\n            flag = false;\r\n        }\r\n        else if (isNaN($('#blood_sugar').val() / 1)) {\r\n            $(\"#blood_sugar_err\").html(\"必須是數字\");\r\n            flag = false;\r\n        }\r\n        if ($('#insulin_type_1').val() != 0 &&  isNaN($('#insulin_value_1').val() / 1)) {\r\n            $(\"#insulin_1_err\").html(\"必須是數字\");\r\n            flag = false;\r\n        }\r\n        if ($('#insulin_type_2').val() != 0 && isNaN($('#insulin_value_2').val() / 1)) {\r\n            $(\"#insulin_2_err\").html(\"必須是數字\");\r\n            flag = false;\r\n        }\r\n        if ($('#insulin_type_3').val() != 0 && isNaN($('#insulin_value_3').val() / 1)) {\r\n            $(\"#insulin_3_err\").html(\"必須是數字\");\r\n            flag = false;\r\n        }\r\n        if (isNaN($('#sugar').val() / 1) ) {\r\n            $(\"#sugar_err\").html(\"必須是數字\");\r\n            flag = false;\r\n        }\r\n        if($(\"#sport\").val() != \"none\" && $(\"#duration\").val() == \"none\"){\r\n            $(\"#sport_err\").html(\"必須填入時間\");\r\n            flag = false;\r\n        }\r\n\r\n        if(flag){\r\n            var insert_data={};\r\n            insert_data['calendar_date'] = $(\"#calendar_date\").html();\r\n            insert_data['measure_time'] = $(\"#calendar_date\").html()+\" \"+$('#timepicker').timepicker('getTime');\r\n            insert_data['measure_type'] = $(\"#range\").attr('value');\r\n            insert_data['blood_sugar'] = $(\"#blood_sugar\").val();\r\n            insert_data['low_blood_sugar'] = $(\"#low\").val();\r\n            if($(\"#sport\").val() != \"none\"){\r\n                insert_data['exercise_type'] = $(\"#sport\").val();\r\n                insert_data['exercise_duration'] = $(\"#duration\").val();\r\n            }\r\n            if($('#insulin_type_1').val() != 0){\r\n                insert_data['insulin_type_1'] = $(\"#insulin_type_1\").val();\r\n                insert_data['insulin_value_1'] = $(\"#insulin_value_1\").val();\r\n            }\r\n            if($('#insulin_type_2').val() != 0){\r\n                insert_data['insulin_type_2'] = $(\"#insulin_type_2\").val();\r\n                insert_data['insulin_value_2'] = $(\"#insulin_value_2\").val();\r\n            }\r\n            if($('#insulin_type_3').val() != 0){\r\n                insert_data['insulin_type_3'] = $(\"#insulin_type_3\").val();\r\n                insert_data['insulin_value_3'] = $(\"#insulin_value_3\").val();\r\n            }\r\n            if($('#sugar').val() != \"\"){\r\n                insert_data['sugar'] = $(\"#sugar\").val();\r\n            }\r\n            if($('#note').val() != \"\"){\r\n                insert_data['note'] = $(\"#note\").val();\r\n            }\r\n            insert_data['_token'] = $('input[name=_token]').val();\r\n            $.ajax({\r\n                type: 'POST',\r\n                url: '/bdata/upsert',\r\n                data: insert_data,\r\n                success: function(result){\r\n                    if(result == \"success\"){\r\n                        //$(\"#filter\").hide();\r\n                        //$(\"#insert_data\").hide();\r\n                        location.reload();\r\n                    }else{\r\n                        alert(\"儲存失敗\");\r\n                    }\r\n                },\r\n                error: function(){\r\n                    alert(\"儲存失敗\");\r\n                }\r\n            });\r\n        }\r\n    });\r\n\r\n    $(\"#cancel\").unbind('click').click(function(event){\r\n        event.preventDefault();\r\n\r\n        $(\"#sport\").val(\"none\");\r\n        $(\"#duration\").val(\"none\");\r\n        $(\"#low\").val(\"0\");\r\n        $(\"#blood_sugar\").val();\r\n        $(\"#insulin_type_1\").val(\"0\");\r\n        $(\"#insulin_type_2\").val(\"0\");\r\n        $(\"#insulin_type_3\").val(\"0\");\r\n        $(\"#insulin_value_1\").val(\"\");\r\n        $(\"#insulin_value_2\").val(\"\");\r\n        $(\"#insulin_value_3\").val(\"\");\r\n        $(\"#sugar\").val(\"\");\r\n        $(\"#note\").val(\"\");\r\n\r\n        $(\"#filter\").hide();\r\n        $(\"#insert_data\").hide();\r\n\r\n    });\r\n\r\n}\r\n\r\nfunction insertFood(calendar_date, type) {\r\n    $(\"#food_calendar_date\").html(calendar_date);\r\n    $(\"#food_range\").html(mapping[type]);\r\n    $(\"#food_range\").attr(\"value\",type);\r\n    $('#food_timepicker').timepicker('setTime', mapping_time[type]);\r\n    setFoodList($(\"#food_category\"), $(\"#food_type_option\"),1);\r\n    setAddFood($(\"#add_food\"));\r\n    setfoodRemove($(\"#delete_food\"));\r\n    $(\"#amount\").focusout(calc_sugar);\r\n    $(\"#food_unit\").focusout(calc_sugar);\r\n\r\n    $.ajax({\r\n        type: 'GET',\r\n        url: '/bdata/food/detail/' + calendar_date + '/' + type,\r\n        success: function(result){\r\n            if(result != null && result[\"summary\"] != null) {\r\n                if (result[\"summary\"][\"food_time\"])\r\n                    $('#food_timepicker').timepicker('setTime', result[\"summary\"][\"food_time\"].split(\" \")[1]);\r\n                else\r\n                    $('#food_timepicker').timepicker('setTime', mapping_time[type]);\r\n                $(\"#sugar_amount\").val(result[\"summary\"][\"sugar_amount\"]);\r\n\r\n                $(\"#food_note\").val(result[\"summary\"][\"food_note\"]);\r\n                $(\"#overall_note\").val(result[\"summary\"][\"note\"]);\r\n\r\n                var foods = result[\"detail\"];\r\n                var row_html = $(\"#sample tr:last\");\r\n                for (var i = 0; i < foods.length; i++) {\r\n                    var tmp_row = row_html.clone();\r\n                    tmp_row.insertAfter('#sample tr:last');\r\n                    tmp_row.find(\"#add_food\").hide();\r\n                    tmp_row.find(\"#delete_food\").show();\r\n                    setfoodRemove(tmp_row.find(\"#delete_food\"));\r\n                    tmp_row.find('td').eq(1).attr(\"pk\",foods[i].food_category_pk).html(foods[i].food_category_name);\r\n                    tmp_row.find('td').eq(2).attr(\"pk\",foods[i].food_pk).html(foods[i].food_name);\r\n                    if (foods[i].amount_gram) {\r\n                        tmp_row.find('td').eq(3).attr(\"sugar\", foods[i].sugar).attr(\"unit\",\"gram\").attr(\"amount\",foods[i].amount_gram ).html(foods[i].amount_gram + \" 克\");\r\n                    }else if (foods[i].amount_set) {\r\n                        tmp_row.find('td').eq(3).attr(\"sugar\", foods[i].sugar).attr(\"unit\",\"set\").attr(\"amount\",foods[i].amount_set).html(foods[i].amount_set + \" 份\");\r\n                    }\r\n\r\n                }\r\n            }\r\n            $(\"#filter\").show();\r\n            $(\"#insert_food_data\").show();\r\n        },\r\n        error: function(){\r\n            $(\"#filter\").show();\r\n            $(\"#insert_food_data\").show();\r\n        }\r\n    });\r\n\r\n    $(\"#food_save\").unbind('click').click(function(event){\r\n        var flag = true;\r\n\r\n        event.preventDefault();\r\n\r\n        var details = [];\r\n        var trs = $(\"#sample > tbody\").children(\"tr\");\r\n\r\n        for(var i = 1; i < trs.length; i++){\r\n            var tr = $(trs[i]);\r\n            var food_category = tr.find('td').eq(1).attr(\"pk\");\r\n            var food_type_option = tr.find('td').eq(2).attr(\"pk\");\r\n            var amount = tr.find('td').eq(3).attr(\"amount\");\r\n            var food_unit = tr.find('td').eq(3).attr(\"unit\");\r\n\r\n            details.push({'food_category':food_category,\r\n                'food_type_option': food_type_option,\r\n                'amount': amount,\r\n                'food_unit': food_unit\r\n            })\r\n        }\r\n\r\n        if(flag){\r\n            var insert_data = {};\r\n            insert_data['calendar_date'] = $(\"#food_calendar_date\").html();\r\n            insert_data['type'] = $(\"#food_range\").attr(\"value\");\r\n            insert_data['food_time'] = $(\"#food_calendar_date\").html() + \" \" +$(\"#food_timepicker\").timepicker(\"getTime\");\r\n            insert_data['details'] = details;\r\n            insert_data['sugar_amount'] = $(\"#sugar_amount\").val();\r\n            insert_data['food_note'] = $(\"#food_note\").val();\r\n            insert_data['overall_note'] = $(\"#overall_note\").val();\r\n            insert_data['_token'] = $('input[name=_token]').val();\r\n\r\n            $.ajax({\r\n                type: 'POST',\r\n                url: '/bdata/upsertfood',\r\n                data: insert_data,\r\n                success: function(result){\r\n                    if(result == \"success\"){\r\n\r\n                        location.reload();\r\n                    }else{\r\n                        alert(\"儲存失敗\");\r\n                    }\r\n                },\r\n                error: function(){\r\n                    alert(\"儲存失敗\");\r\n                }\r\n            });\r\n        }else{\r\n            $(\"#food_note\").focusin();\r\n        }\r\n    });\r\n\r\n    $(\"#food_cancel\").unbind('click').click(function(){\r\n        event.preventDefault();\r\n        $(\"#filter\").hide();\r\n        $(\"#insert_food_data\").hide();\r\n\r\n        init_food_input();\r\n        var trs = $(\"#sample > tbody\").children(\"tr\");\r\n\r\n        for(var i = 1; i < trs.length; i++) {\r\n            $(trs[i]).remove();\r\n        }\r\n        $(\"#sugar_amount\").val(\"\");\r\n        $(\"#food_note\").val(\"\");\r\n        $(\"#overall_note\").val(\"\");\r\n\r\n    });\r\n\r\n    $(\"#delete_food_all\").unbind('click').click(function(){\r\n\r\n        if (confirm(\"確定要刪除嗎?\") == true) {\r\n            $.ajax({\r\n                type: 'DELETE',\r\n                url: '/bdata/foods/'+$(\"#food_calendar_date\").html(),\r\n                data: { _token : $('input[name=_token]').val()},\r\n                success: function(result){\r\n                    if(result == \"success\"){\r\n                        location.reload();\r\n                    }else{\r\n                        alert(\"刪除失敗\");\r\n                    }\r\n                },\r\n                error: function(){\r\n                    alert(\"刪除失敗\");\r\n                }\r\n            });\r\n        }\r\n        event.preventDefault();\r\n    });\r\n}\r\n\r\nfunction filter(text, event){\r\n    if(text != \"\"){\r\n        var insert_data = {\"filter\": text};\r\n        $.ajax({\r\n            type: 'GET',\r\n            url: '/bdata/filter',\r\n            data: insert_data,\r\n            success: function(result){\r\n                if(result){\r\n                    $(\"#filter_data\").html(result);\r\n                }\r\n            },\r\n            error: function(){\r\n            }\r\n        });\r\n    }\r\n    event.preventDefault();\r\n}"],"sourceRoot":"/source/"}
