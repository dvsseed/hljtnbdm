{"version":3,"sources":["bdata.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"bdata.js","sourcesContent":["/**\n * Created by purplebleed on 2015/9/22.\n */\n\nvar mapping = {\n    'early_morning': '凌晨',\n    'morning': '晨起',\n    'breakfast_before': '早餐饭前',\n    'breakfast_after': '早餐饭后',\n    'lunch_before': '中餐饭前',\n    'lunch_after': '中餐饭后',\n    'dinner_before': '晚餐饭前',\n    'dinner_after': '晚餐饭后',\n    'sleep_before': '睡前'\n};\nvar mapping_time = {\n    'early_morning': '00:01',\n    'morning': '06:01',\n    'breakfast_before': '07:01',\n    'breakfast_after': '09:01',\n    'lunch_before': '11:01',\n    'lunch_after': '13:01',\n    'dinner_before': '17:01',\n    'dinner_after': '19:01',\n    'sleep_before': '20:01'\n};\nvar mapping_range = {\n    'early_morning': '00:01~06:00',\n    'morning': '06:01~07:00',\n    'breakfast_before': '07:01~09:00',\n    'breakfast_after': '09:01~11:00',\n    'lunch_before': '11:01~13:00',\n    'lunch_after': '13:01~17:00',\n    'dinner_before': '17:01~19:00',\n    'dinner_after': '19:01~20:00',\n    'sleep_before': '20:01~00:00'\n};\nvar patt = /\\d{4}-\\d{2}-\\d{2}/;\n$( document ).ready(function() {\n\n    $('#sugartable').stickyTableHeaders();\n\n    $(\".menuLink\").on('click', function (e) {\n        $(this).parent().parent().find('.active').removeClass('active');\n        $('.nav').find('.active').removeClass('active');\n        $(this).parent().addClass('active');\n        $('.content').hide();\n\n        if(!$(this).hasClass(\"real\")){\n            e.preventDefault();\n        }\n\n        var link = $(this).attr('href');\n        if( link == '#batchInsert'){\n            link = '#data';\n        }\n\n        $(link).show({\n            duration: 1,\n            always: checkContent\n        });\n        if(link == \"#message\"){\n            setUpMessage();\n        }else if(link == \"#statics\"){\n            getStaticsData();\n        }else if(link == \"#hba1c\"){\n            getHba1cData();\n        }\n    });\n\n    $('#timepicker').timepicker({\n        defaultTime: '00:01',\n        minutes: {\n            starts: 0,\n            ends: 59,\n            interval: 1,\n            manual: []\n        }\n    });\n\n    $('#food_timepicker').timepicker({\n        defaultTime: '00:01',\n        minutes: {\n            starts: 0,\n            ends: 59,\n            interval: 1,\n            manual: []\n        }\n    });\n    $(\"#dialog\").dialog({\n        autoOpen: false\n    });\n\n    if (!Modernizr.inputtypes['date']) {\n        $('input[type=date]').datepicker({\n            dateFormat: 'yy-mm-dd'\n        });\n    }\n\n    var mode = getUrlParameter(\"mode\");\n    if(mode){\n        if($(\"[href =\" +  \"#\" + mode +\"]\").length > 0){\n            $(\"[href =\" +  \"#\" + mode +\"]\").click();\n        }\n        else{\n            $('[href ' + '= #data]').click();\n        }\n    }\n    else{\n        $('[href =' + ' #data]').click();\n    }\n\n    setContactEditSave();\n    setHba1cSave();\n    setBatchDeleteQuery();\n\n    Chart.types.Line.extend({\n        name: \"LineAlt\",\n        initialize: function (data) {\n            Chart.types.Line.prototype.initialize.apply(this, arguments);\n\n            // keep a reference to the original clear\n            this.originalClear = this.clear;\n            this.clear = function () {\n                this.originalClear();\n\n                // 1 x scale unit\n                //var unitX = this.datasets[0].points[1].x - this.datasets[0].points[0].x;\n\n                var yTop = this.scale.startPoint;\n                var yHeight = this.scale.endPoint - this.scale.startPoint;\n\n                var minVal = this.options.scaleStartValue;\n                var maxVal = this.options.scaleSteps + minVal;\n                var red_precentage = (maxVal - 9) / this.options.scaleSteps;\n                var unit_precentage = 1 / this.options.scaleSteps;\n\n                //console.log(this);\n\n                // change your color here\n                this.chart.ctx.fillStyle = 'rgba(250,26,26,1)';\n\n                // we shift it by half a x scale unit to the left because the space between gridline is actually a shared space\n                this.chart.ctx.fillRect(this.scale.xScalePaddingLeft, yTop, this.scale.width - (this.scale.xScalePaddingLeft+this.scale.xScalePaddingRight), red_precentage * yHeight);\n                this.chart.ctx.fillStyle = 'rgba(250,128,0,1)';\n                this.chart.ctx.fillRect(this.scale.xScalePaddingLeft, yTop + red_precentage * yHeight, this.scale.width - (this.scale.xScalePaddingLeft+this.scale.xScalePaddingRight), unit_precentage * yHeight);\n                this.chart.ctx.fillStyle =  'rgba(250,255,77,1)';\n                this.chart.ctx.fillRect(this.scale.xScalePaddingLeft, yTop + (red_precentage + unit_precentage) * yHeight, this.scale.width - (this.scale.xScalePaddingLeft+this.scale.xScalePaddingRight), unit_precentage * yHeight);\n                this.chart.ctx.fillStyle = 'rgba(133,224,26,133)';\n                this.chart.ctx.fillRect(this.scale.xScalePaddingLeft, yTop + (red_precentage + 2 * unit_precentage) * yHeight, this.scale.width - (this.scale.xScalePaddingLeft+this.scale.xScalePaddingRight), yHeight * (1-(red_precentage + 2 * unit_precentage)));\n                this.chart.ctx.fillStyle = 'rgba(0,0,0,1)';\n                this.chart.ctx.fillText(\"平均血糖\", this.scale.xScalePaddingLeft + 4 * this.scale.fontSize - 15, yTop + yHeight + 30);\n\n                /*this.scale.steps = option.scaleEndValue - option.scaleStartValue;\n                this.scale.min = option.scaleStartValue;\n                this.scale.max = option.scaleEndValue;*/\n\n            }\n        }\n    });\n\n});\n\nfunction setBatchDeleteQuery(){\n    $(\"#batch_delete_query\").click(function(){\n        $.ajax({\n            type: 'GET',\n            url: '/bdata/query/' + $(\"#batch_start_date\").val() + '/' + $(\"#batch_end_date\").val(),\n            success: function (result) {\n                $(\"#batch_delete_result\").html(result);\n                setDeleteQuery();\n            }\n        });\n    });\n}\n\nfunction setDeleteQuery(){\n    $(\"#batch_delete_btn\").click(function(){\n        var intput_data = {};\n        intput_data['_token'] = $('input[name=_token]').val();\n        intput_data['start'] = $(\"#batch_start_date\").val();\n        intput_data['end'] = $(\"#batch_end_date\").val();\n        $.ajax({\n            type: 'POST',\n            url: '/bdata/batch_delete',\n            data: intput_data,\n            success: function (result) {\n                if(result == \"success\"){\n                    location.reload();\n                    alert(\"删除成功\");\n                }else{\n                    alert(\"删除失败\");\n                }\n            },\n            error: function(){\n                alert(\"删除失败\");\n            }\n        });\n    });\n}\n\nfunction print_page(link){\n    $(link).blur();\n    window.print();\n}\n\nfunction openDialog(text, event){\n\n    $(\"#dialog\").html(text);\n    $(\"#dialog\").dialog(\"option\", \"position\", {\n        my: \"left+20 top+10\",\n        of: event\n    });\n    $(\"#dialog\").dialog(\"open\");\n    $(this).blur();\n    event.preventDefault();\n}\n\nfunction getUrlParameter(sParam) {\n    var sPageURL = decodeURIComponent(window.location.search.substring(1)),\n        sURLVariables = sPageURL.split('&'),\n        sParameterName,\n        i;\n\n    for (i = 0; i < sURLVariables.length; i++) {\n        sParameterName = sURLVariables[i].split('=');\n\n        if (sParameterName[0] === sParam) {\n            return sParameterName[1] === undefined ? true : sParameterName[1];\n        }\n    }\n};\n\nfunction updateNote(calendar_date, ele){\n    var text = \"\";\n    if(ele != null)\n        text = $(ele).attr('title');\n    $(\"#day_note\").val(text);\n    $(\"#calendar_date_note\").html(calendar_date);\n\n    $(\"#note_filter\").show();\n    $(\"#insert_note_data\").show();\n\n    $(\"#save_note\").unbind('click').click(function(event){\n        var insert_data = {};\n        insert_data['day_note'] = $(\"#day_note\").val();\n        insert_data['calendar_date'] = calendar_date;\n        insert_data['_token'] = $('input[name=_token]').val();\n        $.ajax({\n            type: 'POST',\n            url: '/bdata/upsert_note',\n            data: insert_data,\n            success: function(result){\n                if(result == \"success\"){\n                    location.reload();\n                }else{\n                    alert(\"储存失败\");\n                }\n            },\n            error: function(){\n                alert(\"储存失败\");\n            }\n        });\n        event.preventDefault();\n    });\n\n    $(\"#cancel_note\").unbind('click').click(function(event){\n        $(\"#note_filter\").hide();\n        $(\"#insert_note_data\").hide();\n        event.preventDefault();\n    });\n\n}\n\nfunction checkContent(){\n    if($(this).attr('id') == 'data'){\n        var active = $(\"#top\").find('.active').children('a').attr('href');\n\n        var trs = $(\"#sugartable > tbody\").children(\"tr\");\n        for(var i = 0; i < trs.length; i++){\n            var tr = $(trs[i]);\n            tr.children('td').each (function() {\n                if(active == '#data'){\n                    $(this).children('#normal').show();\n                    $(this).children('#sugar_batch').hide();\n                    $(this).children('#sugar_batch_empty').hide();\n                }else if(active == '#batchInsert'){\n                    $(this).children('#normal').hide();\n                    $(this).children('#sugar_batch').show();\n                    $(this).children('#sugar_batch').unbind('keydown').keydown(setupKey);\n                }\n            });\n\n            if(active == '#batchInsert'){\n                tr.find('#sugar_batch_empty').show();\n                tr.find('#sugar_batch_empty').click(function(){\n                    var tr = $(this).parents('tr');\n                    tr.children('td').each (function() {\n                        $(this).children('#sugar_batch').val(\"\");\n                    });\n                });\n            }\n        }\n        if(active == '#data'){\n            $('.statics_data').show();\n            $('.batch_save_tr').hide();\n        }else if(active == '#batchInsert'){\n            $('.statics_data').hide();\n            $('.batch_save_tr').show();\n        }\n\n        if(active == '#batchInsert'){\n\n            $('#batch_save_btn').unbind('click').click(function(event){\n                $(this).prop('disabled', true);\n                var flag = true;\n                var batch_data = [];\n                var trs = $(\"#sugartable > tbody\").children(\"tr\");\n                for(var i = 0; i < trs.length; i++){\n                    var single_record = {};\n                    var tr = $(trs[i]);\n                    tr.children('td').each (function() {\n                        if($(this).children('#sugar_batch')){\n                            var sugar_value = $(this).children('#sugar_batch').val();\n                            if(isNaN(sugar_value)){\n                                flag = false;\n                                $(this).children('#sugar_batch').addClass('error');\n                            }else if(sugar_value != ''){\n\n                                single_record[$(this).children('#sugar_batch').attr('data')] = sugar_value;\n                            }\n                        }\n                    });\n\n                    if(patt.test(tr.children('td:first').html())){\n                        single_record['calendar_date'] = tr.children('td:first').html();\n                    }\n\n                    if(!$.isEmptyObject(single_record)){\n                        batch_data.push(single_record);\n                    }\n                }\n\n                event.preventDefault();\n                $(this).blur();\n                var inputdata = {};\n                inputdata['sugar_data'] = batch_data;\n                inputdata['_token'] = $('#batch_form > input[ name=_token]').val();\n                $.ajax({\n                    type: 'POST',\n                    url: '/bdata/batch_update',\n                    data: inputdata,\n                    success: function(result){\n                        if(result == 'success'){\n                            location.reload();\n                            alert('储存成功');\n                        }else{\n                            alert('储存失败');\n                        }\n                    }\n                });\n            });\n\n            var href = $(\"#before_two_week\").attr('href');\n            if(href)\n                $(\"#before_two_week\").attr('href', href + \"?mode=batchInsert\");\n            href = $(\"#after_two_week\").attr('href');\n            if(href)\n                $(\"#after_two_week\").attr('href', href + \"?mode=batchInsert\");\n        }\n        else if(active == '#data'){\n            var href = $(\"#before_two_week\").attr('href');\n            href = href.split('?')[0]\n            if(href)\n                $(\"#before_two_week\").attr('href', href);\n            href = $(\"#after_two_week\").attr('href');\n            if(href)\n                $(\"#after_two_week\").attr('href', href);\n        }\n    }\n}\n\nfunction setupKey( event){\n    //top:3\n    var bottom = $(\"#batch_save_btn\").closest(\"tr\")[0].rowIndex;\n\n    var now_x = $(this).closest(\"tr\")[0].rowIndex;\n    var now_y = $(this).closest(\"td\").index();\n    if ( event.which == 37 ) {\n        if(now_y > 1){\n            now_y -= 1;\n        }\n    }\n    else if ( event.which == 39 ) {\n        if(now_y < 9){\n            now_y += 1;\n        }\n    }\n    else if ( event.which == 38 ) {\n        if(now_x > 4){\n            now_x -= 1;\n        }\n    }\n    else if ( event.which == 40 ) {\n        if(now_x < bottom){\n            now_x += 1;\n        }\n    }\n    $('#sugartable tr:eq(' + now_x + ') td:eq(' + now_y + ')').children('#sugar_batch').focus();\n}\n\nfunction setUpMessage(){\n    //setting for message\n    $(\"#messages\").css('height', $( window ).height() - $(\"#top\").offset().top - $(\"#top\").height() - 150 );\n    $(\"#reply\").unbind('click').click(function(event){\n        var inputdata = {};\n        inputdata['message_body'] = $(\"#messagearea\").val();\n        inputdata['_token'] = $('#message_form > input[ name=_token]').val();\n        event.preventDefault();\n\n        if(inputdata['message_body'] == '' ){\n            $(\"#messagearea\").addClass('error');\n        }else{\n            $.ajax({\n                type: 'POST',\n                url: '/bdata/post_message',\n                data: inputdata,\n                success: function(result){\n                    if(result == 'success'){\n                        getMessageData();\n                        $(\"#reply\").blur();\n                        $(\"#messagearea\").val('');\n                    }\n                }\n            });\n        }\n    });\n\n    $('#messages').scroll(function() {\n        if($('#messages').scrollTop() + $('#messages').height() == $(\"#message_table\").height()) {\n            $.ajax({\n                type: 'GET',\n                url: '/bdata/message?start=' + $('#message_count').val(),\n                success: function(result){\n                    var trs = $(result).find(\"tr\");\n                    for(var i = 0; i < trs.length; i++){\n                        var tr = $(trs[i]);\n                        tr.insertAfter('#message_table tr:last');\n                    }\n                    $('#message_count').val(parseInt($('#message_count').val()) + trs.length);\n                }\n            });\n        }\n    });\n\n    getMessageData();\n}\n\nfunction getStaticsData(){\n    $.ajax({\n        type: 'GET',\n        url: '/bdata/food/statics',\n        success: function(result){\n            $(\"#statics\").html(result);\n\n            var bs_chart = $('#bs_chart');\n\n            var option = {\n                legendTemplate : \"<ul class=\\\"<%=name.toLowerCase()%>-legend\\\" style=\\\"margin-top: 10px;\\\"><% for (var i=0; i<segments.length; i++){%><li style=\\\"list-style: none; text-align: left\\\"><span style=\\\"background-color:<%=segments[i].fillColor%>; display: block; float: left; height: 16px; width: 16px; margin-right: 15px;\\\"></span><%if(segments[i].label){%><%=segments[i].label%>  <%=segments[i].value%><%}%></li><%}%></ul>\"\n            };\n\n            if ( bs_chart.length){\n                $.ajax({\n                    trpe: 'GET',\n                    url: '/bdata/blood/chart',\n                    success: function(result){\n                        for(var key in mapping){\n                            var data = [];\n                            var flag = true;\n                            if(result[key] == undefined){\n                                $(\"#bs_chart_\"+ key).parent().prepend(mapping[key]+\"(时间:\" + mapping_range[key] + \") 0笔\");\n                                data = [\n                                    {\n                                        value: 100,\n                                        color:\"#888888\",\n                                        highlight: \"#888888\",\n                                        label: \"无\"\n                                    }\n                                ];\n                                flag = false;\n                            }else{\n                                $(\"#bs_chart_\"+ key).parent().prepend(mapping[key]+\"(时间:\" + mapping_range[key] + \")\" + result[key][\"count\"] + \"笔\");\n                                data = [\n                                    {\n                                        value: result[key][\"above\"].split(\" \")[0],\n                                        color:\"#F7464A\",\n                                        highlight: \"#FF5A5E\",\n                                        label: \"高于目标\"\n                                    },\n                                    {\n                                        value: result[key][\"normal\"].split(\" \")[0],\n                                        color: \"#46BFBD\",\n                                        highlight: \"#5AD3D1\",\n                                        label: \"正常值\"\n                                    },\n                                    {\n                                        value: result[key][\"below\"].split(\" \")[0],\n                                        color: \"#FDB45C\",\n                                        highlight: \"#FFC870\",\n                                        label: \"低于目标\"\n                                    }\n                                ];\n                            }\n\n                            var ctx = $(\"#bs_chart_\"+ key).get(0).getContext(\"2d\");\n                            var myNewChart = new Chart(ctx).Pie(data,option);\n\n                            if(flag){\n                                var html = myNewChart.generateLegend();\n                                $(\"#bs_chart_\"+ key).parent().append(html);\n                            }else{\n                                $(\"#bs_chart_\"+ key).parent().css('padding-bottom','60px');\n                            }\n                        }\n                        //console.log(result);\n                    }\n                })\n            }\n        }\n    });\n}\n\nfunction setHba1cSave(){\n    $(\"#hba1c_goal_save\").click(function () {\n        inputdata = {};\n\n        inputdata['_token'] = $('#hba1c_goal_form > input[ name=_token]').val();\n        inputdata['hba1c_goal'] = $(\"#hba1c_goal\").val();\n\n        $.ajax({\n            type: 'POST',\n            url: '/bdata/post_hba1c_goal',\n            data: inputdata,\n            success: function(result){\n                if(result == 'success') {\n                    alert(\"储存成功\");\n                    //location.reload();\n                    $(\"#hba1c_goal_save\").blur();\n                }\n                else{\n                    alert(\"储存失败\");\n                    $(\"#hba1c_goal_save\").blur();\n                }\n            }\n        });\n    });\n}\n\nfunction setContactEditSave(){\n    $(\"#contact_data_save_btn\").click(function () {\n        inputdata = {};\n\n        inputdata['_token'] = $('#contact_data_save > input[ name=_token]').val();\n        inputdata['start_date'] = $(\"#start_date\").val();\n        inputdata['med_date'] = $(\"#med_date\").val();\n        inputdata['trace_method'] = $(\"#trace_method\").val();\n        inputdata['contact_name'] = $(\"#contact_name\").val();\n        inputdata['contact_description'] = $(\"#contact_description\").val();\n        inputdata['medicine'] = $(\"#medicine\").val();\n        inputdata['contact_time'] = $(\"#contact_time\").val();\n        inputdata['contact_phone'] = $(\"#contact_phone\").val();\n        inputdata['contact_email'] = $(\"#contact_email\").val();\n        inputdata['patient_note'] = $('input[name=patient_note]:checked').val();\n        if(inputdata['patient_note'] == '其他'){\n            inputdata['patient_note'] = $(\"#patient_input\").val();\n        }\n\n        $.ajax({\n            type: 'POST',\n            url: '/bdata/post_contact',\n            data: inputdata,\n            success: function(result){\n                if(result == 'success') {\n                    alert(\"储存成功\");\n                    $(\"#contact_data_save_btn\").blur();\n                    location.reload();\n                }\n                else{\n                    alert(\"储存失败\");\n                    $(\"#contact_data_save_btn\").blur();\n                }\n            },\n            statusCode: {\n                422: function(result) {\n\n                    var text = JSON.parse(result.responseText);\n                    var html = \"\";\n                    console.log(text);\n                    for(var key in text){\n                        var node = text[key];\n                        for(var i = 0;i < node.length; i++){\n                            html += (node[i]+'\\n');\n                        }\n                    }\n                    alert(html);\n                    $(\"#contact_data_save_btn\").blur();\n                }\n            }\n        });\n    });\n\n    $(\"#med_date_after\").change(setMedDate);\n    $(\"#start_date\").change(setMedDate);\n\n    $(\"#trace_day\").change(function(){\n        var days = $(\"#trace_day\").val();\n        if(!isNaN(days) && days !=\"\"){\n            var today = new Date();\n            var today_str =today.getFullYear()+\"-\"+(today.getMonth()+1)+\"-\"+today.getDate();\n            var added_day = addDays(today_str, parseInt(days));\n            $(\"#trace_time\").val(formatNumberLength(added_day.getFullYear(),4)+\"-\"+formatNumberLength(added_day.getMonth()+1,2)+\"-\"+formatNumberLength(added_day.getDate(),2));\n        }\n    });\n    $(\"#trace_modify\").click(function(){\n        inputdata = {}\n        inputdata['_token'] = $('#contact_data_save > input[ name=_token]').val();\n        inputdata['trace_time'] = $(\"#trace_time\").val();\n        $.ajax({\n            type: 'POST',\n            url: '/bdata/post_contact_trace',\n            data: inputdata,\n            success: function(result){\n                if(result == 'success') {\n                    alert(\"储存成功\");\n                    $(\"#trace_modify\").blur();\n                }\n                else{\n                    alert(\"储存失败\");\n                    $(\"#trace_modify\").blur();\n                }\n            }\n        });\n    });\n    $(\"#trace_recover\").click(function(){\n        $(\"#trace_time\").val($(\"#trace_time\").attr(\"data\"));\n    });\n}\n\nfunction setMedDate(){\n    var days = $(\"#med_date_after\").val();\n\n    var timestamp=Date.parse($(\"#start_date\").val());\n    if (!isNaN(timestamp) && !isNaN(days) && days !=\"\"){\n        var added_day = addDays($(\"#start_date\").val(), parseInt(days));\n        $(\"#med_date\").val(formatNumberLength(added_day.getFullYear(),4)+\"-\"+formatNumberLength(added_day.getMonth()+1,2)+\"-\"+formatNumberLength(added_day.getDate(),2));\n    }\n}\n\nfunction formatNumberLength(num, length) {\n    var r = \"\" + num;\n    while (r.length < length) {\n        r = \"0\" + r;\n    }\n    return r;\n}\n\nfunction addDays(date, days) {\n    var result = new Date(date);\n    result.setDate(result.getDate() + days);\n    return result;\n}\n\nfunction hba1cToBS(hba1c){\n    return Math.round((28.7*hba1c-46.7)/18);\n}\n\nfunction getHba1cData(){\n    $(\"#hba1cChart\").width($(\"#blood_title\").width()*0.8);\n    $(\"#hba1cChart\").css('margin-left',$(\"#blood_title\").width()*0.1);\n    $.ajax({\n        type: 'GET',\n        url: '/bdata/hba1c',\n        success: function(result){\n            var data = {\n                labels: [],\n                datasets: [\n                    {\n                        label: \"HBA1C\",\n                        fillColor: \"rgba(220,220,220,0.2)\",\n                        strokeColor: \"rgba(151,187,205,1)\",\n                        pointColor: \"rgba(151,187,205,1)\",\n                        pointStrokeColor: \"#fff\",\n                        pointHighlightFill: \"#fff\",\n                        pointHighlightStroke: \"rgba(151,187,205,1)\",\n                        data: []\n                    }\n                ],\n                fillBackColor:'rgba(255,0,0,1)'\n            };\n            var max_avg = 10;\n            var min_avg = 5;\n\n            data.labels.push(\"\");\n            data.datasets[0].data.push(null);\n            var record_data = result[\"data\"];\n            if(record_data != null && record_data != undefined){\n                for(var i = 0; i < 4; i++){\n                    if(i < record_data.length){\n                        data.labels.push(record_data[i][\"cl_case_date\"]+\" \"+hba1cToBS(record_data[i][\"cl_blood_hba1c\"]) );\n                        data.datasets[0].data.push(record_data[i][\"cl_blood_hba1c\"]);\n                        max_avg = Math.max(record_data[i][\"cl_blood_hba1c\"], max_avg);\n                        min_avg = Math.min(record_data[i][\"cl_blood_hba1c\"], min_avg);\n                    }else{\n                        data.labels.push(\"\");\n                        data.datasets[0].data.push(null);\n                    }\n                }\n            }\n            /*for(var key in result){\n                if(key == 'name'){\n                    continue;\n                }\n                if(result[key][\"avg\"] != null){\n                    data.labels.push(result[key][\"last_date\"].split(\" \")[0]+\" \"+hba1cToBS(result[key][\"avg\"]) + \"     \" + result[key][\"count\"]);\n                    data.datasets[0].data.push(result[key][\"avg\"]);\n                    max_avg = Math.max(result[key][\"avg\"], 10);\n                    min_avg = Math.min(result[key][\"avg\"], 5);\n                }else{\n                    data.labels.push(\"\");\n                    data.datasets[0].data.push(null);\n                }\n            }*/\n            data.labels.push(\"\");\n            data.datasets[0].data.push(null);\n\n            var options = {\n                scaleSteps: Math.ceil(max_avg - min_avg) ,\n                scaleStartValue: Math.floor(min_avg),\n                scaleStepWidth: 1,\n                scaleOverride: true,\n                tooltipTemplate:  function (d) {\n                    console.log(d);\n                    var words = d.label.split(\" \");\n                    return d.value;// + \" \" + words[words.length-1];\n                },\n                showTooltips: true,\n                onAnimationComplete: function()\n                {\n                    this.showTooltip(this.datasets[0].points, true);\n                },\n                tooltipEvents: [],\n                scaleBackdropPaddingX:10\n            };\n\n            var ctx = $(\"#hba1cChart\").get(0).getContext(\"2d\");\n            var myNewHba1cChart = new Chart(ctx).LineAlt(data,options);\n            $(\"#hba1c_loading\").hide();\n            var html = \"\";\n\n            var record_data = result[\"data\"];\n            for( var i = 0; i < record_data.length; i++){\n                html += '<tr><td>';\n                html += '姓名:&nbsp;' + result['name'] + '&nbsp;&nbsp;日期:&nbsp;&nbsp;' + record_data[i]['cl_case_date'] + '&nbsp; A1C: &nbsp;' + record_data[i]['cl_blood_hba1c'] + ' &nbsp;平均血糖值: &nbsp;' + hba1cToBS(record_data[i]['cl_blood_hba1c']) + '&nbsp;&nbsp;' + getControl(record_data[i]['cl_blood_hba1c']) + '<br/>';\n                //html += '總筆數:&nbsp;' + result[key]['count'] + '&nbsp; 資料範圍: &nbsp;' + result[key]['first_date'].split(' ')[0] + '&nbsp;至&nbsp;' + result[key]['last_date'].split(' ')[0];\n                html += '</td></tr>';\n            }\n            /*for(var key in result){\n\n                if(result[key][\"avg\"] != null){\n                    html += '<tr><td>';\n                    html += '姓名:&nbsp;' + result['name'] + '&nbsp;&nbsp;最後日期:&nbsp;&nbsp;' + result[key]['last_date'] + '&nbsp; A1C: &nbsp;' + result[key]['avg'] + ' &nbsp;平均血糖值: &nbsp;' + hba1cToBS(result[key]['avg']) + '&nbsp;&nbsp;' + getControl(result[key]['avg']) + '<br/>';\n                    html += '總筆數:&nbsp;' + result[key]['count'] + '&nbsp; 資料範圍: &nbsp;' + result[key]['first_date'].split(' ')[0] + '&nbsp;至&nbsp;' + result[key]['last_date'].split(' ')[0];\n                    html += '</td></tr>';\n\n                }\n            }*/\n\n            $(\"#hba1c_table\").html(html);\n        }\n    });\n}\n\nfunction getControl(num){\n    if(num >= 9)\n        return \"控制不良\";\n    else if( num >= 8)\n        return \"極待加強\";\n    else if( num >= 7)\n        return \"待加強\";\n    else\n        return \"控制良好\";\n}\n\nfunction getMessageData(){\n    $.ajax({\n        type: 'GET',\n        url: '/bdata/message',\n        success: function(result){\n            $(\"#messages\").html(result);\n        }\n    });\n}\n\nfunction clear(amount,unit){\n    amount.val(\"\");\n    unit.val(\"gram\");\n    calc_sugar();\n}\n\nfunction foodHandler(event){\n    var food_type =event.data.type;\n    var default_value =event.data.value;\n    var food_category =event.data.category;\n    if(food_category.val() != 0){\n\n        $.ajax({\n            type: 'GET',\n            url: '/bdata/foods/'+food_category.val(),\n            success: function(result){\n                var html =\"\";\n\n                if(result.length > 0){\n                    for(i = 0; i < result.length; i++){\n                        if(default_value == result[i].food_pk)\n                            html += \"<option selected value='\" + result[i].food_pk + \"' gram='\" + result[i].gram_sugar_value + \"' set='\" + result[i].set_sugar_value + \"'>\"+result[i].food_name + \"</option>\";\n                        else\n                            html += \"<option value='\" + result[i].food_pk + \"' gram='\" + result[i].gram_sugar_value + \"' set='\" + result[i].set_sugar_value + \"'>\" + result[i].food_name + \" </option>\";\n                    }\n                }\n                else{\n                    html = \"<option value=\\\"0\\\">无</option>\";\n                }\n\n                food_type.html(html);\n\n                set_sugar_option_value();\n                calc_sugar();\n            }\n        });\n    }\n    else{\n        food_type.html(\"<option value=\\\"0\\\">无</option>\");\n    }\n\n\n    clear(food_type.parent().parent(\"tr\").find(\"#amount\"), food_type.parent().parent(\"tr\").find(\"#food_unit\"));\n\n    food_type.change(set_sugar_option_value);\n}\n\nfunction set_sugar_option_value(){\n    var gram_sugar_value = $(\"#food_type_option option:selected\").attr('gram');\n    var set_sugar_value = $(\"#food_type_option option:selected\").attr('set');\n\n    var html = \"<option value=\\\"gram\\\">公克 </option>\";\n    if(set_sugar_value){\n        html += \"<option value=\\\"set\\\">份 </option>\";\n    }\n\n    $(\"#food_unit\").html(html);\n}\n\nfunction calc_sugar(){\n    var trs = $(\"#sample > tbody\").children(\"tr\");\n\n    var total_sugar = 0.0;\n    for(var i = 1; i < trs.length; i++){\n        var tr = $(trs[i]);\n        var amount = tr.find('td').eq(3).attr(\"sugar\");\n        total_sugar += parseFloat(amount);\n    }\n\n    if(!isNaN(total_sugar))\n        $(\"#sugar_amount\").val(total_sugar);\n    else\n        $(\"#sugar_amount\").val(\"0.0\");\n}\n\nfunction setFoodList(food_category, food_type, default_value){\n    food_category.change({category: food_category,type:food_type,value:default_value},foodHandler);\n    food_type.change({type:food_type}, function(event){\n        var food_type = event.data.type;\n        clear(food_type.parent().parent(\"tr\").find(\"#amount\"), food_type.parent().parent(\"tr\").find(\"#food_unit\"));\n    });\n}\n\nfunction setAddFood(food_add_button){\n    food_add_button.click({button:food_add_button },function(event){\n\n        event.preventDefault();\n\n        var add_button = event.data.button;\n        var tr = add_button.parents(\"#sample tr\");\n\n        var food_category_pk =  tr.find(\"#food_category\").val();\n        var food_category_name =  tr.find(\"#food_category option:selected\").text();\n        var food_pk =  tr.find(\"#food_type_option\").val();\n        var food_name =  tr.find(\"#food_type_option option:selected\").text().split(\" \")[0];\n        var amount = tr.find(\"#amount\").val();\n        var unit = tr.find(\"#food_unit\").val();\n        var gram_sugar_value = tr.find(\"#food_type_option option:selected\").attr(\"gram\");\n        var set_sugar_value = tr.find(\"#food_type_option option:selected\").attr(\"set\");\n\n        var flag = true;\n\n        if(food_category_pk <= 0){\n            tr.find(\"#food_category\").addClass(\"error\");\n            flag = false;\n        }\n        if(food_pk <= 0){\n            tr.find(\"#food_type_option\").addClass(\"error\");\n            flag = false;\n        }\n        if(isNaN(amount) || amount <= 0){\n            tr.find(\"#amount\").addClass(\"error\");\n            flag = false;\n        }\n\n        if(flag){\n            var new_row = tr.clone();\n            new_row.insertAfter('#sample tr:last');\n\n            new_row.find(\"#delete_food\").show();\n            new_row.find(\"#add_food\").hide();\n            new_row.find('td').eq(1).attr(\"pk\",food_category_pk).html(food_category_name);\n            new_row.find('td').eq(2).attr(\"pk\",food_pk).html(food_name);\n            if (unit == \"gram\") {\n                var sugar = gram_sugar_value * amount;\n                new_row.find('td').eq(3).attr(\"sugar\", sugar).attr(\"unit\",\"gram\").attr(\"amount\",amount).html(amount + \" 克\");\n\n            }else if (unit == \"set\") {\n                var sugar = set_sugar_value * amount;\n                new_row.find('td').eq(3).attr(\"sugar\", sugar).attr(\"unit\",\"set\").attr(\"amount\",amount).html(amount + \" 份\");\n            }\n\n            setfoodRemove(new_row.find(\"#delete_food\"));\n\n            calc_sugar();\n            init_food_input();\n        }\n\n    });\n}\n\nfunction init_food_input(){\n    var tr = $(\"#sample tr:first\");\n    tr.find(\"#food_category\").removeClass(\"error\");\n    tr.find(\"#food_type_option\").removeClass(\"error\");\n    tr.find(\"#amount\").removeClass(\"error\");\n    tr.find(\"#add_food\").blur();\n\n    tr.find(\"#food_category\").val(\"0\");\n    tr.find(\"#food_type_option\").html(\"<option value=\\\"0\\\">无</option>\");\n    tr.find(\"#amount\").val(\"\");\n    tr.find(\"#food_unit\").val(\"gram\");\n\n}\n\nfunction setfoodRemove(delete_food){\n    delete_food.unbind(\"click\").click({button:delete_food },function(event){\n        event.preventDefault();\n\n        var delete_food = event.data.button;\n        delete_food.parents(\"#sample tr\").remove();\n\n        calc_sugar();\n    });\n}\n\nfunction updateBloodSugar(calendar_date, type, sugar_value) {\n\n    sugar_value = typeof sugar_value !== 'undefined' ? sugar_value : null;\n\n    $(\"#calendar_date\").html(calendar_date);\n    $(\"#range\").html(mapping[type]);\n    $(\"#range\").attr(\"value\",type);\n    $('#timepicker').timepicker('setTime', mapping_time[type]);\n\n    if (sugar_value != null) {\n        $.ajax({\n            method: \"GET\",\n            url: \"/bdata/detail/\" + calendar_date + \"/\" + type\n        }).done(function (result) {\n\n            $(\"#filter\").show();\n            $(\"#insert_data\").show();\n            $(\"#blood_sugar\").val(sugar_value);\n            if (result) {\n                if (result[\"measure_time\"])\n                    $('#timepicker').timepicker('setTime', result[\"measure_time\"].split(\" \")[1]);\n                else\n                    $('#timepicker').timepicker('setTime', mapping_time[type]);\n\n                if (result['exercise_type'] != null) {\n                    $('#sport').val(result['exercise_type']);\n                    $('#duration').val(result['exercise_duration']);\n                }\n                if (result['low_blood_sugar']) {\n                    $('#low').val(result['low_blood_sugar']);\n                }\n                if (result['insulin_type_1']) {\n                    $('#insulin_type_1').val(result['insulin_type_1']);\n                    $('#insulin_value_1').val(result['insulin_value_1']);\n                }\n                if (result['insulin_type_2']) {\n                    $('#insulin_type_2').val(result['insulin_type_2']);\n                    $('#insulin_value_2').val(result['insulin_value_2']);\n                }\n                if (result['insulin_type_3']) {\n                    $('#insulin_type_3').val(result['insulin_type_3']);\n                    $('#insulin_value_3').val(result['insulin_value_3']);\n                }\n                if (result['sugar']) {\n                    $('#sugar').val(result['sugar']);\n                }\n                if (result['note']) {\n                    $('#note').val(result['note']);\n                }\n            }\n\n        });\n    }\n    else{\n        $(\"#filter\").show();\n        $(\"#insert_data\").show();\n    }\n\n    $(\"#save\").unbind('click').click(function(){\n\n        var flag = true;\n\n        $(\"#blood_sugar_err\").html(\"\");\n        $(\"#insulin_1_err\").html(\"\");\n        $(\"#insulin_2_err\").html(\"\");\n        $(\"#insulin_3_err\").html(\"\");\n        $(\"#sugar_err\").html(\"\");\n\n        if($('#blood_sugar').val()  == \"\"){\n            $(\"#blood_sugar_err\").html(\"不能是空白\");\n            flag = false;\n        }\n        else if (isNaN($('#blood_sugar').val() / 1)) {\n            $(\"#blood_sugar_err\").html(\"必须是数字\");\n            flag = false;\n        }\n        if ($('#insulin_type_1').val() != 0 &&  isNaN($('#insulin_value_1').val() / 1)) {\n            $(\"#insulin_1_err\").html(\"必须是数字\");\n            flag = false;\n        }\n        if ($('#insulin_type_2').val() != 0 && isNaN($('#insulin_value_2').val() / 1)) {\n            $(\"#insulin_2_err\").html(\"必须是数字\");\n            flag = false;\n        }\n        if ($('#insulin_type_3').val() != 0 && isNaN($('#insulin_value_3').val() / 1)) {\n            $(\"#insulin_3_err\").html(\"必须是数字\");\n            flag = false;\n        }\n        if (isNaN($('#sugar').val() / 1) ) {\n            $(\"#sugar_err\").html(\"必须是数字\");\n            flag = false;\n        }\n        if($(\"#sport\").val() != \"none\" && $(\"#duration\").val() == \"none\"){\n            $(\"#sport_err\").html(\"必须填入时间\");\n            flag = false;\n        }\n\n        if(flag){\n            var insert_data={};\n            insert_data['calendar_date'] = $(\"#calendar_date\").html();\n            insert_data['measure_time'] = $(\"#calendar_date\").html()+\" \"+$('#timepicker').timepicker('getTime');\n            insert_data['measure_type'] = $(\"#range\").attr('value');\n            insert_data['blood_sugar'] = $(\"#blood_sugar\").val();\n            insert_data['low_blood_sugar'] = $(\"#low\").val();\n            if($(\"#sport\").val() != \"none\"){\n                insert_data['exercise_type'] = $(\"#sport\").val();\n                insert_data['exercise_duration'] = $(\"#duration\").val();\n            }\n            if($('#insulin_type_1').val() != 0){\n                insert_data['insulin_type_1'] = $(\"#insulin_type_1\").val();\n                insert_data['insulin_value_1'] = $(\"#insulin_value_1\").val();\n            }\n            if($('#insulin_type_2').val() != 0){\n                insert_data['insulin_type_2'] = $(\"#insulin_type_2\").val();\n                insert_data['insulin_value_2'] = $(\"#insulin_value_2\").val();\n            }\n            if($('#insulin_type_3').val() != 0){\n                insert_data['insulin_type_3'] = $(\"#insulin_type_3\").val();\n                insert_data['insulin_value_3'] = $(\"#insulin_value_3\").val();\n            }\n            if($('#sugar').val() != \"\"){\n                insert_data['sugar'] = $(\"#sugar\").val();\n            }\n            if($('#note').val() != \"\"){\n                insert_data['note'] = $(\"#note\").val();\n            }\n            insert_data['_token'] = $('input[name=_token]').val();\n            $.ajax({\n                type: 'POST',\n                url: '/bdata/upsert',\n                data: insert_data,\n                success: function(result){\n                    if(result == \"success\"){\n                        //$(\"#filter\").hide();\n                        //$(\"#insert_data\").hide();\n                        location.reload();\n                    }else{\n                        alert(\"储存失败\");\n                    }\n                },\n                error: function(){\n                    alert(\"储存失败\");\n                }\n            });\n        }\n    });\n\n    $(\"#cancel\").unbind('click').click(function(event){\n        event.preventDefault();\n\n        $(\"#sport\").val(\"none\");\n        $(\"#duration\").val(\"none\");\n        $(\"#low\").val(\"0\");\n        $(\"#blood_sugar\").val(\"\");\n        $(\"#insulin_type_1\").val(\"0\");\n        $(\"#insulin_type_2\").val(\"0\");\n        $(\"#insulin_type_3\").val(\"0\");\n        $(\"#insulin_value_1\").val(\"\");\n        $(\"#insulin_value_2\").val(\"\");\n        $(\"#insulin_value_3\").val(\"\");\n        $(\"#sugar\").val(\"\");\n        $(\"#note\").val(\"\");\n\n        $(\"#filter\").hide();\n        $(\"#insert_data\").hide();\n\n    });\n\n}\n\nfunction insertFood(calendar_date, type) {\n    $(\"#food_calendar_date\").html(calendar_date);\n    $(\"#food_range\").html(mapping[type]);\n    $(\"#food_range\").attr(\"value\",type);\n    $('#food_timepicker').timepicker('setTime', mapping_time[type]);\n    setFoodList($(\"#food_category\"), $(\"#food_type_option\"),1);\n    setAddFood($(\"#add_food\"));\n    setfoodRemove($(\"#delete_food\"));\n    $(\"#amount\").focusout(calc_sugar);\n    $(\"#food_unit\").focusout(calc_sugar);\n\n    $.ajax({\n        type: 'GET',\n        url: '/bdata/food/detail/' + calendar_date + '/' + type,\n        success: function(result){\n            if(result != null && result[\"summary\"] != null) {\n                if (result[\"summary\"][\"food_time\"])\n                    $('#food_timepicker').timepicker('setTime', result[\"summary\"][\"food_time\"].split(\" \")[1]);\n                else\n                    $('#food_timepicker').timepicker('setTime', mapping_time[type]);\n                $(\"#sugar_amount\").val(result[\"summary\"][\"sugar_amount\"]);\n\n                $(\"#food_note\").val(result[\"summary\"][\"food_note\"]);\n                $(\"#overall_note\").val(result[\"summary\"][\"note\"]);\n\n                var foods = result[\"detail\"];\n                var row_html = $(\"#sample tr:last\");\n                for (var i = 0; i < foods.length; i++) {\n                    var tmp_row = row_html.clone();\n                    tmp_row.insertAfter('#sample tr:last');\n                    tmp_row.find(\"#add_food\").hide();\n                    tmp_row.find(\"#delete_food\").show();\n                    setfoodRemove(tmp_row.find(\"#delete_food\"));\n                    tmp_row.find('td').eq(1).attr(\"pk\",foods[i].food_category_pk).html(foods[i].food_category_name);\n                    tmp_row.find('td').eq(2).attr(\"pk\",foods[i].food_pk).html(foods[i].food_name);\n                    if (foods[i].amount_gram) {\n                        tmp_row.find('td').eq(3).attr(\"sugar\", foods[i].sugar).attr(\"unit\",\"gram\").attr(\"amount\",foods[i].amount_gram ).html(foods[i].amount_gram + \" 克\");\n                    }else if (foods[i].amount_set) {\n                        tmp_row.find('td').eq(3).attr(\"sugar\", foods[i].sugar).attr(\"unit\",\"set\").attr(\"amount\",foods[i].amount_set).html(foods[i].amount_set + \" 份\");\n                    }\n\n                }\n            }\n            $(\"#filter\").show();\n            $(\"#insert_food_data\").show();\n        },\n        error: function(){\n            $(\"#filter\").show();\n            $(\"#insert_food_data\").show();\n        }\n    });\n\n    $(\"#food_save\").unbind('click').click(function(event){\n        var flag = true;\n\n        event.preventDefault();\n\n        var details = [];\n        var trs = $(\"#sample > tbody\").children(\"tr\");\n\n        for(var i = 1; i < trs.length; i++){\n            var tr = $(trs[i]);\n            var food_category = tr.find('td').eq(1).attr(\"pk\");\n            var food_type_option = tr.find('td').eq(2).attr(\"pk\");\n            var amount = tr.find('td').eq(3).attr(\"amount\");\n            var food_unit = tr.find('td').eq(3).attr(\"unit\");\n\n            details.push({'food_category':food_category,\n                'food_type_option': food_type_option,\n                'amount': amount,\n                'food_unit': food_unit\n            })\n        }\n\n        if(flag){\n            var insert_data = {};\n            insert_data['calendar_date'] = $(\"#food_calendar_date\").html();\n            insert_data['type'] = $(\"#food_range\").attr(\"value\");\n            insert_data['food_time'] = $(\"#food_calendar_date\").html() + \" \" +$(\"#food_timepicker\").timepicker(\"getTime\");\n            insert_data['details'] = details;\n            insert_data['sugar_amount'] = $(\"#sugar_amount\").val();\n            insert_data['food_note'] = $(\"#food_note\").val();\n            insert_data['overall_note'] = $(\"#overall_note\").val();\n            insert_data['_token'] = $('input[name=_token]').val();\n\n            $.ajax({\n                type: 'POST',\n                url: '/bdata/upsertfood',\n                data: insert_data,\n                success: function(result){\n                    if(result == \"success\"){\n\n                        location.reload();\n                    }else{\n                        alert(\"储存失败\");\n                    }\n                },\n                error: function(){\n                    alert(\"储存失败\");\n                }\n            });\n        }else{\n            $(\"#food_note\").focusin();\n        }\n    });\n\n    $(\"#food_cancel\").unbind('click').click(function(){\n        event.preventDefault();\n        $(\"#filter\").hide();\n        $(\"#insert_food_data\").hide();\n\n        init_food_input();\n        var trs = $(\"#sample > tbody\").children(\"tr\");\n\n        for(var i = 1; i < trs.length; i++) {\n            $(trs[i]).remove();\n        }\n        $(\"#sugar_amount\").val(\"\");\n        $(\"#food_note\").val(\"\");\n        $(\"#overall_note\").val(\"\");\n\n    });\n\n    $(\"#delete_food_all\").unbind('click').click(function(){\n\n        if (confirm(\"确定要删除吗?\") == true) {\n            $.ajax({\n                type: 'DELETE',\n                url: '/bdata/foods/'+$(\"#food_calendar_date\").html(),\n                data: { _token : $('input[name=_token]').val()},\n                success: function(result){\n                    if(result == \"success\"){\n                        location.reload();\n                    }else{\n                        alert(\"删除失败\");\n                    }\n                },\n                error: function(){\n                    alert(\"删除失败\");\n                }\n            });\n        }\n        event.preventDefault();\n    });\n}\n\nfunction filter(text, event){\n    if(text != \"\"){\n        var insert_data = {\"filter\": text};\n        $.ajax({\n            type: 'GET',\n            url: '/bdata/filter',\n            data: insert_data,\n            success: function(result){\n                if(result){\n                    $(\"#filter_data\").html(result);\n                }\n            },\n            error: function(){\n            }\n        });\n    }\n    event.preventDefault();\n}"],"sourceRoot":"/source/"}