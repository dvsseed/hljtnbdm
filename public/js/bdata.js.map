{"version":3,"sources":["bdata.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"bdata.js","sourcesContent":["/**\n * Created by purplebleed on 2015/9/22.\n */\n\nvar mapping = {\n    'early_morning': '凌晨',\n    'morning': '晨起',\n    'breakfast_before': '早餐飯前',\n    'breakfast_after': '早餐飯後',\n    'lunch_before': '中餐飯前',\n    'lunch_after': '中餐飯後',\n    'dinner_before': '晚餐飯前',\n    'dinner_after': '晚餐飯後',\n    'sleep_before': '睡前'\n};\nvar mapping_time = {\n    'early_morning': '00:01',\n    'morning': '06:01',\n    'breakfast_before': '07:01',\n    'breakfast_after': '09:01',\n    'lunch_before': '11:01',\n    'lunch_after': '13:01',\n    'dinner_before': '17:01',\n    'dinner_after': '19:01',\n    'sleep_before': '20:01'\n};\nvar patt = /\\d{4}-\\d{2}-\\d{2}/;\n$( document ).ready(function() {\n\n    $(\".menuLink\").on('click', function (e) {\n        $(this).parent().parent().find('.active').removeClass('active');\n        $('.nav').find('.active').removeClass('active');\n        $(this).parent().addClass('active');\n        $('.content').hide();\n\n        if(!$(this).hasClass(\"real\")){\n            e.preventDefault();\n        }\n\n        var link = $(this).attr('href');\n        if( link == '#batchInsert'){\n            link = '#data';\n        }\n\n        $(link).show({\n            duration: 1,\n            always: checkContent\n        });\n        if($(this).attr('href') == \"#message\"){\n            setUpMessage();\n        }else if($(this).attr('href') == \"#statics\"){\n            getStaticsData();\n        }\n    });\n\n    $('#timepicker').timepicker({\n        defaultTime: '00:01',\n        minutes: {\n            starts: 0,\n            ends: 59,\n            interval: 1,\n            manual: []\n        }\n    });\n\n    $('#food_timepicker').timepicker({\n        defaultTime: '00:01',\n        minutes: {\n            starts: 0,\n            ends: 59,\n            interval: 1,\n            manual: []\n        }\n    });\n    $(\"#dialog\").dialog({\n        autoOpen: false\n    });\n\n    var mode = getUrlParameter(\"mode\");\n    if(mode){\n        if($(\"[href =\" +  \"#\" + mode +\"]\").length > 0){\n            $(\"[href =\" +  \"#\" + mode +\"]\").click();\n        }\n        else{\n            $('[href ' + '= #data]').click();\n        }\n    }\n    else{\n        $('[href =' + ' #data]').click();\n    }\n});\n\nfunction openDialog(text, event){\n\n\n    $(\"#dialog\").html(text);\n    $(\"#dialog\").dialog(\"option\", \"position\", {\n        my: \"left+20 top+10\",\n        of: event\n    });\n    $(\"#dialog\").dialog(\"open\");\n    $(this).blur();\n    event.preventDefault();\n}\n\nfunction getUrlParameter(sParam) {\n    var sPageURL = decodeURIComponent(window.location.search.substring(1)),\n        sURLVariables = sPageURL.split('&'),\n        sParameterName,\n        i;\n\n    for (i = 0; i < sURLVariables.length; i++) {\n        sParameterName = sURLVariables[i].split('=');\n\n        if (sParameterName[0] === sParam) {\n            return sParameterName[1] === undefined ? true : sParameterName[1];\n        }\n    }\n};\n\nfunction updateNote(calendar_date, ele){\n    var text = \"\";\n    if(ele != null)\n        text = $(ele).attr('title');\n    $(\"#day_note\").val(text);\n    $(\"#calendar_date_note\").html(calendar_date);\n\n    $(\"#note_filter\").show();\n    $(\"#insert_note_data\").show();\n\n    $(\"#save_note\").unbind('click').click(function(event){\n        var insert_data = {};\n        insert_data['day_note'] = $(\"#day_note\").val();\n        insert_data['calendar_date'] = calendar_date;\n        insert_data['_token'] = $('input[name=_token]').val();\n        $.ajax({\n            type: 'POST',\n            url: '/bdata/upsert_note',\n            data: insert_data,\n            success: function(result){\n                if(result == \"success\"){\n                    location.reload();\n                }else{\n                    alert(\"儲存失敗\");\n                }\n            },\n            error: function(){\n                alert(\"儲存失敗\");\n            }\n        });\n        event.preventDefault();\n    });\n\n    $(\"#cancel_note\").unbind('click').click(function(event){\n        $(\"#note_filter\").hide();\n        $(\"#insert_note_data\").hide();\n        event.preventDefault();\n    });\n\n}\n\nfunction checkContent(){\n    if($(this).attr('id') == 'data'){\n        var active = $(\"#top\").find('.active').children('a').attr('href');\n\n        var trs = $(\"#sugartable > tbody\").children(\"tr\");\n        for(var i = 2; i < trs.length; i++){\n            var tr = $(trs[i]);\n            tr.children('td').each (function() {\n                if(active == '#data'){\n                    $(this).children('#normal').show();\n                    $(this).children('#sugar_batch').hide();\n                    $(this).children('#sugar_batch_empty').hide();\n                }else if(active == '#batchInsert'){\n                    $(this).children('#normal').hide();\n                    $(this).children('#sugar_batch').show();\n                }\n            });\n\n            if(active == '#batchInsert'){\n                tr.find('#sugar_batch_empty').show();\n                tr.find('#sugar_batch_empty').click(function(){\n                    var tr = $(this).parents('tr');\n                    tr.children('td').each (function() {\n                        $(this).children('#sugar_batch').val(\"\");\n                    });\n                });\n            }\n        }\n        if(active == '#data'){\n            $('.statics_data').show();\n            $('.batch_save_tr').hide();\n        }else if(active == '#batchInsert'){\n            $('.statics_data').hide();\n            $('.batch_save_tr').show();\n        }\n\n        if(active == '#batchInsert'){\n\n            $('#batch_save_btn').unbind('click').click(function(event){\n                $(this).prop('disabled', true);\n                var flag = true;\n                var batch_data = [];\n                var trs = $(\"#sugartable > tbody\").children(\"tr\");\n                for(var i = 2; i < trs.length; i++){\n                    var single_record = {};\n                    var tr = $(trs[i]);\n                    tr.children('td').each (function() {\n                        if($(this).children('#sugar_batch')){\n                            var sugar_value = $(this).children('#sugar_batch').val();\n                            if(isNaN(sugar_value)){\n                                flag = false;\n                                $(this).children('#sugar_batch').addClass('error');\n                            }else if(sugar_value != ''){\n\n                                single_record[$(this).children('#sugar_batch').attr('data')] = sugar_value;\n                            }\n                        }\n                    });\n\n                    if(patt.test(tr.children('td:first').html())){\n                        single_record['calendar_date'] = tr.children('td:first').html();\n                    }\n\n                    if(!$.isEmptyObject(single_record)){\n                        batch_data.push(single_record);\n                    }\n                }\n                console.log(batch_data);\n                event.preventDefault();\n                $(this).blur();\n                var inputdata = {};\n                inputdata['sugar_data'] = batch_data;\n                inputdata['_token'] = $('#batch_form > input[ name=_token]').val();\n                $.ajax({\n                    type: 'POST',\n                    url: '/bdata/batch_update',\n                    data: inputdata,\n                    success: function(result){\n                        if(result == 'success'){\n                            location.reload();\n                        }\n                    }\n                });\n            });\n\n            var href = $(\"#before_two_week\").attr('href');\n            if(href)\n                $(\"#before_two_week\").attr('href', href + \"?mode=batchInsert\");\n            href = $(\"#after_two_week\").attr('href');\n            if(href)\n                $(\"#after_two_week\").attr('href', href + \"?mode=batchInsert\");\n        }\n        else if(active == '#data'){\n            var href = $(\"#before_two_week\").attr('href');\n            href = href.split('?')[0]\n            if(href)\n                $(\"#before_two_week\").attr('href', href);\n            href = $(\"#after_two_week\").attr('href');\n            if(href)\n                $(\"#after_two_week\").attr('href', href);\n        }\n    }\n}\n\nfunction setUpBatch(){\n    $(\"#batch\").click(function(event){\n        event.preventDefault();\n        $(this).parent().parent().find('.active').removeClass('active');\n        $('.nav').find('.active').removeClass('active');\n        $(this).parent().addClass('active');\n        $('#data').show();\n\n        var trs = $(\"#sugartable > tbody\").children(\"tr\");\n        for(var i = 2; i < trs.length; i++){\n            var tr = $(trs[i]);\n            tr.children('td').each (function() {\n                $(this).children('#normal').hide();\n                $(this).children('#sugar_batch').show();\n            });\n            tr.find('#sugar_batch_empty').show();\n            tr.find('#sugar_batch_empty').click(function(){\n                var tr = $(this).parents('tr');\n                tr.children('td').each (function() {\n                    $(this).children('#sugar_batch').val(\"\");\n                });\n            });\n        }\n\n        $('.statics_data').hide();\n        $('.batch_save_tr').show();\n    });\n}\n\nfunction setUpMessage(){\n    //setting for message\n    $(\"#messages\").css('height', $( window ).height() - $(\"#top\").offset().top - $(\"#top\").height() - 150 );\n    $(\"#reply\").click(function(event){\n        var inputdata = {};\n        inputdata['message_body'] = $(\"#messagearea\").val();\n        inputdata['_token'] = $('#message_form > input[ name=_token]').val();\n        event.preventDefault();\n\n        if(inputdata['message_body'] == '' ){\n            $(\"#messagearea\").addClass('error');\n        }else{\n            $.ajax({\n                type: 'POST',\n                url: '/bdata/post_message',\n                data: inputdata,\n                success: function(result){\n                    if(result == 'success'){\n                        getMessageData();\n                        $(\"#reply\").blur();\n                        $(\"#messagearea\").val('');\n                    }\n                }\n            });\n        }\n    });\n\n    $('#messages').scroll(function() {\n        if($('#messages').scrollTop() + $('#messages').height() == $(\"#message_table\").height()) {\n            $.ajax({\n                type: 'GET',\n                url: '/bdata/message?start=' + $('#message_count').val(),\n                success: function(result){\n                    var trs = $(result).find(\"tr\");\n                    for(var i = 0; i < trs.length; i++){\n                        var tr = $(trs[i]);\n                        tr.insertAfter('#message_table tr:last');\n                    }\n                    $('#message_count').val(parseInt($('#message_count').val()) + trs.length);\n                }\n            });\n        }\n    });\n\n    getMessageData();\n}\n\nfunction getStaticsData(){\n    $.ajax({\n        type: 'GET',\n        url: '/bdata/food/statics',\n        success: function(result){\n            $(\"#statics\").html(result);\n        }\n    });\n}\n\nfunction getMessageData(){\n    $.ajax({\n        type: 'GET',\n        url: '/bdata/message',\n        success: function(result){\n            $(\"#messages\").html(result);\n        }\n    });\n}\n\nfunction clear(amount,unit){\n    amount.val(\"\");\n    unit.val(\"gram\");\n    calc_sugar();\n}\n\nfunction foodHandler(event){\n    var food_type =event.data.type;\n    var default_value =event.data.value;\n    var food_category =event.data.category;\n    if(food_category.val() != 0){\n\n        $.ajax({\n            type: 'GET',\n            url: '/bdata/foods/'+food_category.val(),\n            success: function(result){\n                var html =\"\";\n\n                if(result.length > 0){\n                    for(i = 0; i < result.length; i++){\n                        if(default_value == result[i].food_pk)\n                            html += \"<option selected value='\" + result[i].food_pk + \"' gram='\" + result[i].gram_sugar_value + \"' set='\" + result[i].set_sugar_value + \"'>\"+result[i].food_name + \"</option>\";\n                        else\n                            html += \"<option value='\" + result[i].food_pk + \"' gram='\" + result[i].gram_sugar_value + \"' set='\" + result[i].set_sugar_value + \"'>\" + result[i].food_name + \" </option>\";\n                    }\n                }\n                else{\n                    html = \"<option value=\\\"0\\\">無</option>\";\n                }\n\n                food_type.html(html);\n\n                set_sugar_option_value();\n                calc_sugar();\n            }\n        });\n    }\n    else{\n        food_type.html(\"<option value=\\\"0\\\">無</option>\");\n    }\n\n\n    clear(food_type.parent().parent(\"tr\").find(\"#amount\"), food_type.parent().parent(\"tr\").find(\"#food_unit\"));\n\n    food_type.change(set_sugar_option_value);\n}\n\nfunction set_sugar_option_value(){\n    var gram_sugar_value = $(\"#food_type_option option:selected\").attr('gram');\n    var set_sugar_value = $(\"#food_type_option option:selected\").attr('set');\n\n    var html = \"<option value=\\\"gram\\\">公克 < \" + gram_sugar_value + \"克 ></option>\";\n    if(set_sugar_value){\n        html += \"<option value=\\\"gram\\\">份 < \" + set_sugar_value + \"克 ></option>\";\n    }\n\n    $(\"#food_unit\").html(html);\n}\n\nfunction calc_sugar(){\n    var trs = $(\"#sample > tbody\").children(\"tr\");\n\n    var total_sugar = 0.0;\n    for(var i = 1; i < trs.length; i++){\n        var tr = $(trs[i]);\n        var amount = tr.find('td').eq(3).attr(\"sugar\");\n        total_sugar += parseFloat(amount);\n    }\n\n    if(!isNaN(total_sugar))\n        $(\"#sugar_amount\").val(total_sugar);\n    else\n        $(\"#sugar_amount\").val(\"0.0\");\n}\n\nfunction setFoodList(food_category, food_type, default_value){\n    food_category.change({category: food_category,type:food_type,value:default_value},foodHandler);\n    food_type.change({type:food_type}, function(event){\n        var food_type = event.data.type;\n        clear(food_type.parent().parent(\"tr\").find(\"#amount\"), food_type.parent().parent(\"tr\").find(\"#food_unit\"));\n    });\n}\n\nfunction setAddFood(food_add_button){\n    food_add_button.click({button:food_add_button },function(event){\n\n        event.preventDefault();\n\n        var add_button = event.data.button;\n        var tr = add_button.parents(\"#sample tr\");\n\n        var food_category_pk =  tr.find(\"#food_category\").val();\n        var food_category_name =  tr.find(\"#food_category option:selected\").text();\n        var food_pk =  tr.find(\"#food_type_option\").val();\n        var food_name =  tr.find(\"#food_type_option option:selected\").text().split(\" \")[0];\n        var amount = tr.find(\"#amount\").val();\n        var unit = tr.find(\"#food_unit\").val();\n        var gram_sugar_value = tr.find(\"#food_type_option option:selected\").attr(\"gram\");\n        var set_sugar_value = tr.find(\"#food_type_option option:selected\").attr(\"set\");\n\n        var flag = true;\n\n        if(food_category_pk <= 0){\n            tr.find(\"#food_category\").addClass(\"error\");\n            flag = false;\n        }\n        if(food_pk <= 0){\n            tr.find(\"#food_type_option\").addClass(\"error\");\n            flag = false;\n        }\n        if(isNaN(amount) || amount <= 0){\n            tr.find(\"#amount\").addClass(\"error\");\n            flag = false;\n        }\n\n        if(flag){\n            var new_row = tr.clone();\n            new_row.insertAfter('#sample tr:last');\n\n            new_row.find(\"#delete_food\").show();\n            new_row.find(\"#add_food\").hide();\n            new_row.find('td').eq(1).attr(\"pk\",food_category_pk).html(food_category_name);\n            new_row.find('td').eq(2).attr(\"pk\",food_pk).html(food_name);\n            if (unit == \"gram\") {\n                var sugar = gram_sugar_value * amount;\n                new_row.find('td').eq(3).attr(\"sugar\", sugar).attr(\"unit\",\"gram\").attr(\"amount\",amount).html(amount + \" 克\");\n\n            }else if (unit == \"set\") {\n                var sugar = set_sugar_value * amount;\n                new_row.find('td').eq(3).attr(\"sugar\", sugar).attr(\"unit\",\"set\").attr(\"amount\",amount).html(amount + \" 份\");\n            }\n\n            setfoodRemove(new_row.find(\"#delete_food\"));\n\n            calc_sugar();\n            init_food_input();\n        }\n\n    });\n}\n\nfunction init_food_input(){\n    var tr = $(\"#sample tr:first\");\n    tr.find(\"#food_category\").removeClass(\"error\");\n    tr.find(\"#food_type_option\").removeClass(\"error\");\n    tr.find(\"#amount\").removeClass(\"error\");\n    tr.find(\"#add_food\").blur();\n\n    tr.find(\"#food_category\").val(\"0\");\n    tr.find(\"#food_type_option\").html(\"<option value=\\\"0\\\">無</option>\");\n    tr.find(\"#amount\").val(\"\");\n    tr.find(\"#food_unit\").val(\"gram\");\n\n}\n\nfunction setfoodRemove(delete_food){\n    delete_food.unbind(\"click\").click({button:delete_food },function(event){\n        event.preventDefault();\n\n        var delete_food = event.data.button;\n        delete_food.parents(\"#sample tr\").remove();\n\n        calc_sugar();\n    });\n}\n\nfunction updateBloodSugar(calendar_date, type, sugar_value) {\n\n    sugar_value = typeof sugar_value !== 'undefined' ? sugar_value : null;\n\n    $(\"#calendar_date\").html(calendar_date);\n    $(\"#range\").html(mapping[type]);\n    $(\"#range\").attr(\"value\",type);\n    $('#timepicker').timepicker('setTime', mapping_time[type]);\n\n    if (sugar_value != null) {\n        $.ajax({\n            method: \"GET\",\n            url: \"/bdata/detail/\" + calendar_date + \"/\" + type\n        }).done(function (result) {\n\n            $(\"#filter\").show();\n            $(\"#insert_data\").show();\n            $(\"#blood_sugar\").val(sugar_value);\n            if (result) {\n                if (result[\"measure_time\"])\n                    $('#timepicker').timepicker('setTime', result[\"measure_time\"].split(\" \")[1]);\n                else\n                    $('#timepicker').timepicker('setTime', mapping_time[type]);\n\n                if (result['exercise_type'] != null) {\n                    $('#sport').val(result['exercise_type']);\n                    $('#duration').val(result['exercise_duration']);\n                }\n                if (result['low_blood_sugar']) {\n                    $('#low').val(result['low_blood_sugar']);\n                }\n                if (result['insulin_type_1']) {\n                    $('#insulin_type_1').val(result['insulin_type_1']);\n                    $('#insulin_value_1').val(result['insulin_value_1']);\n                }\n                if (result['insulin_type_2']) {\n                    $('#insulin_type_2').val(result['insulin_type_2']);\n                    $('#insulin_value_2').val(result['insulin_value_2']);\n                }\n                if (result['insulin_type_3']) {\n                    $('#insulin_type_3').val(result['insulin_type_3']);\n                    $('#insulin_value_3').val(result['insulin_value_3']);\n                }\n                if (result['sugar']) {\n                    $('#sugar').val(result['sugar']);\n                }\n                if (result['note']) {\n                    $('#note').val(result['note']);\n                }\n            }\n\n        });\n    }\n    else{\n        $(\"#filter\").show();\n        $(\"#insert_data\").show();\n    }\n\n    $(\"#save\").unbind('click').click(function(){\n\n        var flag = true;\n\n        $(\"#blood_sugar_err\").html(\"\");\n        $(\"#insulin_1_err\").html(\"\");\n        $(\"#insulin_2_err\").html(\"\");\n        $(\"#insulin_3_err\").html(\"\");\n        $(\"#sugar_err\").html(\"\");\n\n        if($('#blood_sugar').val()  == \"\"){\n            $(\"#blood_sugar_err\").html(\"不能是空白\");\n            flag = false;\n        }\n        else if (isNaN($('#blood_sugar').val() / 1)) {\n            $(\"#blood_sugar_err\").html(\"必須是數字\");\n            flag = false;\n        }\n        if ($('#insulin_type_1').val() != 0 &&  isNaN($('#insulin_value_1').val() / 1)) {\n            $(\"#insulin_1_err\").html(\"必須是數字\");\n            flag = false;\n        }\n        if ($('#insulin_type_2').val() != 0 && isNaN($('#insulin_value_2').val() / 1)) {\n            $(\"#insulin_2_err\").html(\"必須是數字\");\n            flag = false;\n        }\n        if ($('#insulin_type_3').val() != 0 && isNaN($('#insulin_value_3').val() / 1)) {\n            $(\"#insulin_3_err\").html(\"必須是數字\");\n            flag = false;\n        }\n        if (isNaN($('#sugar').val() / 1) ) {\n            $(\"#sugar_err\").html(\"必須是數字\");\n            flag = false;\n        }\n        if($(\"#sport\").val() != \"none\" && $(\"#duration\").val() == \"none\"){\n            $(\"#sport_err\").html(\"必須填入時間\");\n            flag = false;\n        }\n\n        if(flag){\n            var insert_data={};\n            insert_data['calendar_date'] = $(\"#calendar_date\").html();\n            insert_data['measure_time'] = $(\"#calendar_date\").html()+\" \"+$('#timepicker').timepicker('getTime');\n            insert_data['measure_type'] = $(\"#range\").attr('value');\n            insert_data['blood_sugar'] = $(\"#blood_sugar\").val();\n            insert_data['low_blood_sugar'] = $(\"#low\").val();\n            if($(\"#sport\").val() != \"none\"){\n                insert_data['exercise_type'] = $(\"#sport\").val();\n                insert_data['exercise_duration'] = $(\"#duration\").val();\n            }\n            if($('#insulin_type_1').val() != 0){\n                insert_data['insulin_type_1'] = $(\"#insulin_type_1\").val();\n                insert_data['insulin_value_1'] = $(\"#insulin_value_1\").val();\n            }\n            if($('#insulin_type_2').val() != 0){\n                insert_data['insulin_type_2'] = $(\"#insulin_type_2\").val();\n                insert_data['insulin_value_2'] = $(\"#insulin_value_2\").val();\n            }\n            if($('#insulin_type_3').val() != 0){\n                insert_data['insulin_type_3'] = $(\"#insulin_type_3\").val();\n                insert_data['insulin_value_3'] = $(\"#insulin_value_3\").val();\n            }\n            if($('#sugar').val() != \"\"){\n                insert_data['sugar'] = $(\"#sugar\").val();\n            }\n            if($('#note').val() != \"\"){\n                insert_data['note'] = $(\"#note\").val();\n            }\n            insert_data['_token'] = $('input[name=_token]').val();\n            $.ajax({\n                type: 'POST',\n                url: '/bdata/upsert',\n                data: insert_data,\n                success: function(result){\n                    if(result == \"success\"){\n                        //$(\"#filter\").hide();\n                        //$(\"#insert_data\").hide();\n                        location.reload();\n                    }else{\n                        alert(\"儲存失敗\");\n                    }\n                },\n                error: function(){\n                    alert(\"儲存失敗\");\n                }\n            });\n        }\n    });\n\n    $(\"#cancel\").unbind('click').click(function(event){\n        event.preventDefault();\n\n        $(\"#sport\").val(\"none\");\n        $(\"#duration\").val(\"none\");\n        $(\"#low\").val(\"0\");\n        $(\"#blood_sugar\").val();\n        $(\"#insulin_type_1\").val(\"0\");\n        $(\"#insulin_type_2\").val(\"0\");\n        $(\"#insulin_type_3\").val(\"0\");\n        $(\"#insulin_value_1\").val(\"\");\n        $(\"#insulin_value_2\").val(\"\");\n        $(\"#insulin_value_3\").val(\"\");\n        $(\"#sugar\").val(\"\");\n        $(\"#note\").val(\"\");\n\n        $(\"#filter\").hide();\n        $(\"#insert_data\").hide();\n\n    });\n\n}\n\nfunction insertFood(calendar_date, type) {\n    $(\"#food_calendar_date\").html(calendar_date);\n    $(\"#food_range\").html(mapping[type]);\n    $(\"#food_range\").attr(\"value\",type);\n    $('#food_timepicker').timepicker('setTime', mapping_time[type]);\n    setFoodList($(\"#food_category\"), $(\"#food_type_option\"),1);\n    setAddFood($(\"#add_food\"));\n    setfoodRemove($(\"#delete_food\"));\n    $(\"#amount\").focusout(calc_sugar);\n    $(\"#food_unit\").focusout(calc_sugar);\n\n    $.ajax({\n        type: 'GET',\n        url: '/bdata/food/detail/' + calendar_date + '/' + type,\n        success: function(result){\n            if(result != null && result[\"summary\"] != null) {\n                if (result[\"summary\"][\"food_time\"])\n                    $('#food_timepicker').timepicker('setTime', result[\"summary\"][\"food_time\"].split(\" \")[1]);\n                else\n                    $('#food_timepicker').timepicker('setTime', mapping_time[type]);\n                $(\"#sugar_amount\").val(result[\"summary\"][\"sugar_amount\"]);\n\n                $(\"#food_note\").val(result[\"summary\"][\"food_note\"]);\n                $(\"#overall_note\").val(result[\"summary\"][\"note\"]);\n\n                var foods = result[\"detail\"];\n                var row_html = $(\"#sample tr:last\");\n                for (var i = 0; i < foods.length; i++) {\n                    var tmp_row = row_html.clone();\n                    tmp_row.insertAfter('#sample tr:last');\n                    tmp_row.find(\"#add_food\").hide();\n                    tmp_row.find(\"#delete_food\").show();\n                    setfoodRemove(tmp_row.find(\"#delete_food\"));\n                    tmp_row.find('td').eq(1).attr(\"pk\",foods[i].food_category_pk).html(foods[i].food_category_name);\n                    tmp_row.find('td').eq(2).attr(\"pk\",foods[i].food_pk).html(foods[i].food_name);\n                    if (foods[i].amount_gram) {\n                        tmp_row.find('td').eq(3).attr(\"sugar\", foods[i].sugar).attr(\"unit\",\"gram\").attr(\"amount\",foods[i].amount_gram ).html(foods[i].amount_gram + \" 克\");\n                    }else if (foods[i].amount_set) {\n                        tmp_row.find('td').eq(3).attr(\"sugar\", foods[i].sugar).attr(\"unit\",\"set\").attr(\"amount\",foods[i].amount_set).html(foods[i].amount_set + \" 份\");\n                    }\n\n                }\n            }\n            $(\"#filter\").show();\n            $(\"#insert_food_data\").show();\n        },\n        error: function(){\n            $(\"#filter\").show();\n            $(\"#insert_food_data\").show();\n        }\n    });\n\n    $(\"#food_save\").unbind('click').click(function(event){\n        var flag = true;\n\n        event.preventDefault();\n\n        var details = [];\n        var trs = $(\"#sample > tbody\").children(\"tr\");\n\n        for(var i = 1; i < trs.length; i++){\n            var tr = $(trs[i]);\n            var food_category = tr.find('td').eq(1).attr(\"pk\");\n            var food_type_option = tr.find('td').eq(2).attr(\"pk\");\n            var amount = tr.find('td').eq(3).attr(\"amount\");\n            var food_unit = tr.find('td').eq(3).attr(\"unit\");\n\n            details.push({'food_category':food_category,\n                'food_type_option': food_type_option,\n                'amount': amount,\n                'food_unit': food_unit\n            })\n        }\n\n        if(flag){\n            var insert_data = {};\n            insert_data['calendar_date'] = $(\"#food_calendar_date\").html();\n            insert_data['type'] = $(\"#food_range\").attr(\"value\");\n            insert_data['food_time'] = $(\"#food_calendar_date\").html() + \" \" +$(\"#food_timepicker\").timepicker(\"getTime\");\n            insert_data['details'] = details;\n            insert_data['sugar_amount'] = $(\"#sugar_amount\").val();\n            insert_data['food_note'] = $(\"#food_note\").val();\n            insert_data['overall_note'] = $(\"#overall_note\").val();\n            insert_data['_token'] = $('input[name=_token]').val();\n\n            $.ajax({\n                type: 'POST',\n                url: '/bdata/upsertfood',\n                data: insert_data,\n                success: function(result){\n                    if(result == \"success\"){\n\n                        location.reload();\n                    }else{\n                        alert(\"儲存失敗\");\n                    }\n                },\n                error: function(){\n                    alert(\"儲存失敗\");\n                }\n            });\n        }else{\n            $(\"#food_note\").focusin();\n        }\n    });\n\n    $(\"#food_cancel\").unbind('click').click(function(){\n        event.preventDefault();\n        $(\"#filter\").hide();\n        $(\"#insert_food_data\").hide();\n\n        init_food_input();\n        var trs = $(\"#sample > tbody\").children(\"tr\");\n\n        for(var i = 1; i < trs.length; i++) {\n            $(trs[i]).remove();\n        }\n        $(\"#sugar_amount\").val(\"\");\n        $(\"#food_note\").val(\"\");\n        $(\"#overall_note\").val(\"\");\n\n    });\n\n    $(\"#delete_food_all\").unbind('click').click(function(){\n\n        if (confirm(\"確定要刪除嗎?\") == true) {\n            $.ajax({\n                type: 'DELETE',\n                url: '/bdata/foods/'+$(\"#food_calendar_date\").html(),\n                data: { _token : $('input[name=_token]').val()},\n                success: function(result){\n                    if(result == \"success\"){\n                        location.reload();\n                    }else{\n                        alert(\"刪除失敗\");\n                    }\n                },\n                error: function(){\n                    alert(\"刪除失敗\");\n                }\n            });\n        }\n        event.preventDefault();\n    });\n}"],"sourceRoot":"/source/"}